name: Pulse AmazÃ´nia â€“ Coleta e ImportaÃ§Ã£o AutomÃ¡tica

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * *'   # roda todo dia Ã s 09:00 UTC

jobs:
  coleta-import:
    runs-on: ubuntu-latest

    steps:

      # 1ï¸âƒ£ Checkout
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Python
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3ï¸âƒ£ Instalar dependÃªncias
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytrends pandas requests supabase

      # 4ï¸âƒ£ Rodar coleta automÃ¡tica
      - name: ğŸ”„ Run automatic collection
        run: |
          python coleta_automatica_trends.py

      # 5ï¸âƒ£ Commit automÃ¡tico do CSV atualizado
      - name: ğŸ’¾ Commit updated CSV files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add coleta-trends-para.csv
          git add coleta-concorrentes-nacionais.csv
          git commit -m "AtualizaÃ§Ã£o automÃ¡tica de coleta diÃ¡ria" || echo "Sem alteraÃ§Ãµes"
          git push

      # 6ï¸âƒ£ Importar destinos ParÃ¡
      - name: ğŸŒ´ Import PA destinations
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          CSV_PATH: coleta-trends-para.csv
        run: |
          python import_csv_amazonia.py

      # 7ï¸âƒ£ Importar concorrentes nacionais
      - name: ğŸŒ Import National Competitors
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          CSV_PATH: coleta-concorrentes-nacionais.csv
        run: |
          python import_csv_concorrentes.py

      # 8ï¸âƒ£ Log de sucesso
      - name: âœ… Import completed
        if: success()
        run: |
          echo "âœ… Coleta e ImportaÃ§Ã£o concluÃ­das com sucesso."
          echo "ğŸŒ´ Tabela: pulse_amazonia"
          echo "ğŸŒ Tabela: concorrentes_nacionais"

      # 9ï¸âƒ£ Log de erro
      - name: âŒ Import failed
        if: failure()
        run: |
          echo "âŒ Falha na coleta ou importaÃ§Ã£o."
          echo "ğŸ” Verifique os logs do GitHub Actions."

      # ğŸ”Ÿ Enviar e-mail se falhar
      - name: ğŸ“§ Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "ğŸš¨ Pulse AmazÃ´nia â€“ Falha na Coleta/ImportaÃ§Ã£o"
          to: ${{ secrets.SMTP_USER }}
          from: Pulse AmazÃ´nia
          body: |
            O workflow automÃ¡tico do Pulse AmazÃ´nia falhou.

            Verifique imediatamente:
            https://github.com/${{ github.repository }}/actions
