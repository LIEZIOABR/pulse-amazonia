name: Import CSV to Supabase

# Dispara quando houver push nos arquivos CSV
on:
  push:
    paths:
      - 'coleta-trends-para.csv'
      - 'coleta-concorrentes-nacionais.csv'
  workflow_dispatch:

jobs:
  import-data:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout do repositÃ³rio
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      # 2. Configurar Python 3.11
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Instalar dependÃªncias
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip --no-cache-dir
          pip install supabase --no-cache-dir --force-reinstall

      # 4. Importar destinos ParÃ¡
      - name: ğŸŒ´ Import PA destinations
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          CSV_PATH: coleta-trends-para.csv
        run: |
          python import_csv_amazonia.py

      # 5. Importar concorrentes nacionais
      - name: ğŸŒ Import National Competitors
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          CSV_PATH: coleta-concorrentes-nacionais.csv
        run: |
          python import_csv_concorrentes.py

      # 6. Log de sucesso
      - name: âœ… Import completed
        if: success()
        run: |
          echo "âœ… ImportaÃ§Ã£o concluÃ­da com sucesso!"
          echo "ğŸ“Š Dados PA + Concorrentes disponÃ­veis no Supabase"
          echo "ğŸŒ´ Tabela: pulse_amazonia"
          echo "ğŸŒ Tabela: concorrentes_nacionais"

      # 7. Log de erro
      - name: âŒ Import failed
        if: failure()
        run: |
          echo "âŒ ImportaÃ§Ã£o falhou!"
          echo "ğŸ” Verifique os logs do GitHub Actions"

      # 8. Enviar e-mail se falhar
      - name: ğŸ“§ Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USER }}
          password: ${{ secrets.SMTP_PASS }}
          subject: "ğŸš¨ Pulse AmazÃ´nia â€“ Falha na ImportaÃ§Ã£o"
          to: ${{ secrets.SMTP_USER }}
          from: Pulse AmazÃ´nia
          body: |
            O workflow de importaÃ§Ã£o do Pulse AmazÃ´nia falhou.

            Verifique imediatamente:
            https://github.com/${{ github.repository }}/actions

            RecomendaÃ§Ã£o:
            1. Identificar qual script falhou
            2. Corrigir erro
            3. Executar workflow manualmente
