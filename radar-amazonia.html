<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEMAND PULSE AMAZ√îNIA - ABR Consultoria</title>
    <link rel=\"icon\" href=\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='52' font-size='52'%3Eüå¥%3C/text%3E%3C/svg%3E\">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    
    <!-- Leaflet CSS e JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        /* ========== RESET & VARI√ÅVEIS ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Poppins', sans-serif; overflow-x: hidden; min-height: 100vh; }
        
        :root {
            --accent: #00c6ff; --bg: #000000; --panel: rgba(15, 18, 22, 0.75); --panel-border: rgba(255, 255, 255, 0.1); --text-main: #eaf3ff; --text-dim: #9ca3af; --accent-green: #39ff14;
            --shadow: 0 8px 32px rgba(0, 198, 255, 0.15); --glow: 0 0 20px rgba(0, 198, 255, 0.4);
        }
        
        /* ========== MATRIX BACKGROUND ========== */
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.2; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        
        /* ========== HEADER ========== */
        .header { text-align: center; margin-bottom: 40px; padding-top: 20px; position: relative; }
        .header-nav { position: absolute; top: 20px; left: 0; display: flex; gap: 10px; z-index: 10; }
        .btn-nav { border: 1px solid var(--accent); padding: 8px 16px; border-radius: 999px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.3s; text-transform: uppercase; background: transparent; color: var(--accent); text-decoration: none; display: inline-block; }
        .btn-nav:hover { background: rgba(0,198,255,0.15); box-shadow: 0 0 20px rgba(0, 198, 255, 0.4); }
        
        .logo-section { margin-bottom: 30px; animation: fadeIn 1.5s ease-out; }
        .logo-section img { max-width: 230px; filter: drop-shadow(0 0 15px rgba(0, 198, 255, 0.3)); pointer-events: none; }
        
        h1 { font-size: 3.6rem; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }
        .subtitle { color: var(--text-dim); font-size: 0.9rem; max-width: 800px; margin: 0 auto; line-height: 1.5; font-weight: 400; }
        
        /* ========== LAYOUT GRID ========== */
        .layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-content { flex: 1; }
        .sidebar { width: 380px; position: sticky; top: 20px; }
        
        /* ========== CONTROLS ========== */
        .controls { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 24px; margin-bottom: 30px; backdrop-filter: blur(14px); box-shadow: var(--shadow); }
        .date-filter-group { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--panel-border); margin-bottom: 15px; align-items: center; }
        .filter-label { font-size: 0.7rem; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        select, input[type="date"] { background: rgba(0,0,0,0.4); border: 1px solid var(--panel-border); color: white; padding: 10px; border-radius: 10px; font-size: 0.8rem; cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        .btn-update { width: 100%; background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: #001018; border: none; padding: 14px; border-radius: 14px; font-weight: 800; cursor: pointer; font-size: 1rem; transition: 0.3s; text-transform: uppercase; }
        .btn-update:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,198,255,0.4); }
        
        /* ========== TIMELINE CHART ========== */
        .timeline-section { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(14px); box-shadow: var(--shadow); }
        .section-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 20px; color: var(--accent); display: flex; align-items: center; gap: 12px; }
        .chart-wrapper { position: relative; height: 400px; }
        
        /* ========== GEO MAP ========== */
        .map-section { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(14px); box-shadow: var(--shadow); }
        .map-container { 
            height: 550px; 
            border-radius: 16px; 
            overflow: hidden; 
            border: 2px solid rgba(0, 198, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 198, 255, 0.15);
        }
        
        /* Leaflet popup customization */
        .leaflet-popup-content-wrapper {
            background: rgba(15, 18, 22, 0.95) !important;
            color: #eaf3ff !important;
            border: 1px solid rgba(0, 198, 255, 0.3) !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5) !important;
        }
        .leaflet-popup-content {
            margin: 16px !important;
            font-family: 'Poppins', sans-serif !important;
        }
        .leaflet-popup-tip {
            background: rgba(15, 18, 22, 0.95) !important;
            border: 1px solid rgba(0, 198, 255, 0.3) !important;
        }
        .popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #00c6ff;
            margin-bottom: 10px;
        }
        .popup-metric {
            font-size: 0.85rem;
            margin: 6px 0;
            color: #eaf3ff;
        }
        .popup-metric strong {
            color: #00c6ff;
        }
        .popup-origins {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* ========== DESTINATION CARDS ========== */
        .destinations-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dest-card { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 16px; padding: 20px; backdrop-filter: blur(14px); transition: 0.3s; cursor: pointer; }
        .dest-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,198,255,0.25); border-color: var(--accent); }
        
        .dest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .dest-name { font-size: 1.1rem; font-weight: 600; color: var(--accent); }
        .dest-rank { background: rgba(0,198,255,0.2); color: var(--accent); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; }
        
        .metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 1rem; font-weight: 700; color: white; }
        .metric-value.positive { color: #39ff14; }
        .metric-value.negative { color: #ff3860; }
        .metric-value.neutral { color: #ffea00; }
        
        /* NOVOS √çNDICES ESTRAT√âGICOS */
        .indice-destaque {
            margin-top: 12px;
            padding: 12px;
            background: rgba(0, 198, 255, 0.05);
            border-left: 3px solid var(--accent);
            border-radius: 8px;
        }
        .indice-titulo {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--accent);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        .indice-valor {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .indice-descricao {
            font-size: 0.7rem;
            color: var(--text-dim);
            line-height: 1.4;
        }
        
        /* BADGE DE CONFIABILIDADE */
        .badge-confianca {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-top: 8px;
        }
        .badge-confianca.alta { background: rgba(57, 255, 20, 0.15); color: #39ff14; }
        .badge-confianca.media { background: rgba(255, 234, 0, 0.15); color: #ffea00; }
        .badge-confianca.baixa { background: rgba(255, 56, 96, 0.15); color: #ff3860; }
        
        .origins-list { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
        .origin-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 0.85rem; }
        .origin-name { color: var(--text-dim); }
        .origin-pct { color: var(--accent); font-weight: 600; }
        
        /* ========== BOLETIM ESTRAT√âGICO ========== */
        .boletim { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 24px; backdrop-filter: blur(14px); box-shadow: var(--shadow); margin-bottom: 20px; }
        .boletim-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .boletim-title { font-size: 1.2rem; font-weight: 800; color: var(--accent); }
        .btn-copy { background: rgba(0,198,255,0.1); border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-copy:hover { background: rgba(0,198,255,0.2); }
        
        .boletim-content { font-size: 0.85rem; line-height: 1.7; color: var(--text-dim); }
        .boletim-section { margin-bottom: 16px; }
        .boletim-section-title { font-weight: 700; color: white; margin-bottom: 8px; font-size: 0.9rem; }
        .boletim-list { list-style: none; padding-left: 0; }
        .boletim-list li { padding-left: 16px; position: relative; margin-bottom: 6px; }
        .boletim-list li:before { content: "‚ñ∏"; position: absolute; left: 0; color: var(--accent); font-weight: 800; }
        
        /* IPCR - COMPETITIVIDADE NACIONAL */
        .ipcr-section { 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 2px solid rgba(0, 198, 255, 0.2);
        }
        .ipcr-item {
            background: rgba(0, 198, 255, 0.05);
            border-left: 3px solid var(--accent);
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
        }
        .ipcr-destino {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 6px;
        }
        .ipcr-comparacao {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 4px;
        }
        .ipcr-status {
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 6px;
        }
        .ipcr-status.ganhando { color: #39ff14; }
        .ipcr-status.perdendo { color: #ff3860; }
        .ipcr-status.estavel { color: #ffea00; }
        
        /* ========== CALEND√ÅRIO ========== */
        .calendar-section { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 24px; backdrop-filter: blur(14px); box-shadow: var(--shadow); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-month { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
        .calendar-nav { display: flex; gap: 8px; }
        .btn-cal-nav { background: rgba(0,198,255,0.1); border: 1px solid var(--panel-border); color: var(--accent); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-cal-nav:hover { background: rgba(0,198,255,0.2); border-color: var(--accent); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day-label { text-align: center; font-size: 0.7rem; font-weight: 700; color: var(--text-dim); padding: 8px 0; text-transform: uppercase; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); border-radius: 10px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; position: relative; }
        .calendar-day:hover { background: rgba(0,198,255,0.1); border-color: var(--accent); }
        .calendar-day.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .calendar-day.selected { background: var(--accent); color: #001018; font-weight: 800; border-color: var(--accent); }
        .calendar-day.has-data:after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--accent-green); border-radius: 50%; }
        
        /* ========== DICION√ÅRIO DE KPIs ========== */
        .kpi-dict { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 16px; padding: 20px; backdrop-filter: blur(14px); box-shadow: var(--shadow); margin-top: 20px; }
        .kpi-dict-title { font-size: 1rem; font-weight: 700; color: var(--accent); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .kpi-item { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .kpi-item:last-child { border-bottom: none; }
        .kpi-name { font-size: 0.85rem; font-weight: 700; color: white; margin-bottom: 4px; }
        .kpi-desc { font-size: 0.75rem; color: var(--text-dim); line-height: 1.5; }
        
        /* ========== LOADING & EMPTY STATES ========== */
        .loading { text-align: center; padding: 60px 20px; color: var(--text-dim); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(0,198,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        /* ========== RESPONSIVIDADE ========== */
        @media (max-width: 1200px) {
            .layout { flex-direction: column; }
            .sidebar { width: 100%; position: static; }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .destinations-grid { grid-template-columns: 1fr; }
            .header-nav { position: static; justify-content: center; margin-bottom: 20px; }
            .map-container { height: 400px; }
        }
    </style>
</head>
<body>
    <!-- Matrix Background Canvas -->
    <canvas id="matrix-canvas"></canvas>
    
    <div class="container">
        <!-- HEADER -->
        <header class="header">
            <div class="header-nav">
                <a href="index.html" class="btn-nav">‚Üê Voltar ao HUB</a>
            </div>
            <div class="logo-section">
                <img src="abr-logo.png" alt="ABR Logo">
            </div>
            <h1>DEMAND PULSE AMAZ√îNIA</h1>
            <p class="subtitle">
                Radar de Intelig√™ncia Tur√≠stica do Par√° - Monitoramento de 15 destinos amaz√¥nicos
            </p>
        </header>
        
        <div class="layout">
            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- CONTROLS -->
                <section class="controls">
                    <div class="date-filter-group">
                        <div>
                            <div class="filter-label">Per√≠odo</div>
                            <select id="period-select">
                                <option value="7">√öltimos 7 dias</option>
                                <option value="14">√öltimos 14 dias</option>
                                <option value="30" selected>√öltimos 30 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div id="custom-dates" style="display: none;">
                            <input type="date" id="date-start" />
                            <input type="date" id="date-end" />
                        </div>
                    </div>
                    <button class="btn-update" onclick="atualizarDados()">ATUALIZAR DADOS</button>
                </section>
                
                <!-- TIMELINE CHART -->
                <section class="timeline-section">
                    <h2 class="section-title">Timeline Comparativa - Top 5 Destinos</h2>
                    <div class="chart-wrapper">
                        <canvas id="timeline-chart"></canvas>
                    </div>
                </section>
                
                <!-- GEO MAP -->
                <section class="map-section">
                    <h2 class="section-title">Mapa Geogr√°fico - Distribui√ß√£o Espacial do Interesse</h2>
                    <div id="map" class="map-container"></div>
                </section>
                
                <!-- DESTINATION CARDS -->
                <div id="destinations-container" class="destinations-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
            
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <!-- BOLETIM ESTRAT√âGICO -->
                <section class="boletim">
                    <div class="boletim-header">
                        <h3 class="boletim-title">Boletim Estrat√©gico</h3>
                        <button class="btn-copy" onclick="copiarBoletim()">üìã Copiar</button>
                    </div>
                    <div class="boletim-content" id="boletim-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚Äî</div>
                            <p>Clique em um destino para ver detalhes...</p>
                        </div>
                    </div>
                </section>
                
                <!-- CALEND√ÅRIO -->
                <section class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-month" id="calendar-month">Janeiro 2026</div>
                        <div class="calendar-nav">
                            <button class="btn-cal-nav" onclick="navegarMes(-1)">‚óÄ</button>
                            <button class="btn-cal-nav" onclick="navegarMes(1)">‚ñ∂</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                </section>
                
                <!-- DICION√ÅRIO KPIs -->
                
<section class="kpi-dict">
    <h3 class="kpi-dict-title">Dicion√°rio Executivo de Intelig√™ncia</h3>

    <div class="kpi-item">
        <div class="kpi-name">Interesse (0‚Äì100)</div>
        <div class="kpi-desc">
            Representa o pulso digital do destino. Funciona como peso estat√≠stico nas m√©tricas agregadas 
            e indica a for√ßa relativa de atra√ß√£o de demanda no ambiente online.
        </div>
    </div>

    <div class="kpi-item">
        <div class="kpi-name">Varia√ß√£o Percentual</div>
        <div class="kpi-desc">
            Mede acelera√ß√£o ou desacelera√ß√£o da procura em rela√ß√£o √† coleta anterior. 
            Indica dire√ß√£o estrat√©gica de curto prazo.
        </div>
    </div>

    <div class="kpi-item">
        <div class="kpi-name">Share de Mercado PA</div>
        <div class="kpi-desc">
            Participa√ß√£o relativa dentro dos 15 destinos monitorados. 
            Demonstra posicionamento competitivo estadual.
        </div>
    </div>

    <div class="kpi-item">
        <div class="kpi-name">Press√£o de Demanda</div>
        <div class="kpi-desc">
            √çndice composto que identifica intensidade competitiva e risco de concentra√ß√£o de mercado. 
            Auxilia decis√µes de precifica√ß√£o e posicionamento.
        </div>
    </div>

    <div class="kpi-item">
        <div class="kpi-name">Momentum</div>
        <div class="kpi-desc">
            Avalia velocidade e consist√™ncia do movimento da demanda. 
            Indica tend√™ncia estrutural de crescimento ou perda de tra√ß√£o.
        </div>
    </div>

    <div class="kpi-item">
        <div class="kpi-name">IPCR ‚Äì Competitividade Regional</div>
        <div class="kpi-desc">
            Compara desempenho do destino com concorrentes nacionais diretos. 
            Identifica ganho ou perda de competitividade fora do estado.
        </div>
    </div>

    <div class="kpi-item">
        <div class="kpi-name">Mercado Emissor (Camada 2)</div>
        <div class="kpi-desc">
            Ajuste estat√≠stico que reduz vi√©s end√≥geno e identifica mercados externos recorrentes. 
            Melhora leitura estrat√©gica de origem real da demanda.
        </div>
    </div>
</section>

            </aside>
        </div>
    </div>
    
    <!-- FOOTER -->
    <footer style="text-align: center; padding: 30px 20px; margin-top: 50px; border-top: 1px solid rgba(0,198,255,0.3); color: rgba(255,255,255,0.6); font-size: 13px; position: relative; z-index: 1;">
        <p style="margin: 8px 0; font-size: 14px;">
            <span style="display: inline-flex; align-items: center; gap: 8px;">
                üîí <strong>Sistema Blindado</strong>
            </span>
        </p>
        <p style="margin: 5px 0; font-size: 12px; color: rgba(255,255,255,0.5);">
            @ Todos os direitos reservados a ABR Marketing Estrat√©gico &amp; Consultoria Hoteleira.
        </p>
    </footer>
    
    <script>
        // ========== CONFIGURA√á√ÉO SUPABASE ==========
        const SUPABASE_URL = 'https://ljeoxnxezjmfbqngoqxz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqZW94bnhlemptZmJxbmdvcXh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMzI3ODUsImV4cCI6MjA4NDYwODc4NX0.B112AG5HTFvJTXaxL2IrdoJf5fcSC-GEHKLsDwdsFgc';
        
        if (typeof supabase === 'undefined') {
            console.error('ERRO: Biblioteca Supabase n√£o carregada!');
        } else {
            console.log('‚úÖ Biblioteca Supabase carregada com sucesso');
        }
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('‚úÖ Cliente Supabase inicializado');
        
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let dadosGlobais = [];
        let dadosConcorrentes = [];
        let chartInstance = null;
        let mapInstance = null;
        let mesAtual = new Date();
        
        const DESTINOS_INFO = {
            'belem': { nome: 'Bel√©m', emoji: 'üèôÔ∏è', lat: -1.4558, lng: -48.4902 },
            'alter_do_chao': { nome: 'Alter do Ch√£o', emoji: 'üèñÔ∏è', lat: -2.5013, lng: -54.9535 },
            'ilha_marajo': { nome: 'Ilha de Maraj√≥', emoji: 'üêÉ', lat: -0.9833, lng: -49.5667 },
            'santarem': { nome: 'Santar√©m', emoji: '‚õµ', lat: -2.4411, lng: -54.7083 },
            'salinopolis': { nome: 'Salin√≥polis', emoji: 'üåä', lat: -0.6145, lng: -47.3559 },
            'soure': { nome: 'Soure', emoji: 'ü¶©', lat: -0.7167, lng: -48.5167 },
            'salvaterra': { nome: 'Salvaterra', emoji: 'üå¥', lat: -0.7553, lng: -48.5141 },
            'mosqueiro': { nome: 'Mosqueiro', emoji: 'üèùÔ∏è', lat: -1.1500, lng: -48.3833 },
            'braganca': { nome: 'Bragan√ßa', emoji: 'ü¶Ä', lat: -1.0536, lng: -46.7664 },
            'monte_alegre': { nome: 'Monte Alegre', emoji: 'üóª', lat: -2.0067, lng: -54.0711 },
            'algodoal': { nome: 'Algodoal', emoji: 'ü••', lat: -0.6167, lng: -47.6167 },
            'obidos': { nome: '√ìbidos', emoji: 'üè∞', lat: -1.9056, lng: -55.5203 },
            'cameta': { nome: 'Camet√°', emoji: 'üé£', lat: -2.2442, lng: -49.4961 },
            'parauapebas': { nome: 'Parauapebas', emoji: '‚õèÔ∏è', lat: -6.0672, lng: -49.9022 },
            'castanhal': { nome: 'Castanhal', emoji: 'üå∞', lat: -1.2936, lng: -47.9216 },
            'maraba': { nome: 'Marab√°', emoji: 'üèûÔ∏è', lat: -5.3686, lng: -49.1178 },
            'ilha_do_marajo': { nome: 'Ilha do Maraj√≥', emoji: 'üêÉ', lat: -0.9833, lng: -49.5667 },
        };
        
        // MAPEAMENTO DE CONCORR√äNCIA NACIONAL (EXPANDIDO)
        const MAPA_CONCORRENCIA = {
            'belem': ['manaus', 'sao_luis'],
            'santarem': ['manaus', 'parintins'],
            'alter_do_chao': ['bonito', 'presidente_figueiredo', 'jalapao'],
            'salinopolis': ['lencois_maranhenses'],
            'algodoal': ['atins', 'lencois_maranhenses'],
            'ilha_marajo': ['atins'],
            'monte_alegre': ['jalapao'],
            'soure': ['atins'],
            'braganca': ['lencois_maranhenses'],
            'salvaterra': ['atins'],
            'mosqueiro': ['atins', 'lencois_maranhenses'],
            'obidos': ['parintins', 'sao_luis'],
            'cameta': ['parintins', 'sao_luis'],
            'parauapebas': ['manaus'],
            'castanhal': ['sao_luis', 'parintins'],
            'maraba': ['manaus'],
            'ilha_do_marajo': ['atins'],
        };
        
        const CONCORRENTES_INFO = {
            'manaus': { nome: 'Manaus (AM)' },
            'sao_luis': { nome: 'S√£o Lu√≠s (MA)' },
            'lencois_maranhenses': { nome: 'Len√ß√≥is Maranhenses (MA)' },
            'jalapao': { nome: 'Jalap√£o (TO)' },
            'bonito': { nome: 'Bonito (MS)' },
            'presidente_figueiredo': { nome: 'Presidente Figueiredo (AM)' },
            'parintins': { nome: 'Parintins (AM)' },
            'atins': { nome: 'Atins (MA)' }
        };
        
        // ============================================================
        // PULSE CAMADA 2 (PROXY DE MERCADO EMISSOR) ‚Äî BLOCO ISOLADO
        // Objetivo: neutralizar vi√©s end√≥geno (origem local)
        // ============================================================
        
        // CONFIG: UF local de cada destino
        const PULSE_LOCAL_UF_BY_DESTINO = {
            'belem': 'PA',
            'alter_do_chao': 'PA',
            'ilha_marajo': 'PA',
            'santarem': 'PA',
            'salinopolis': 'PA',
            'soure': 'PA',
            'salvaterra': 'PA',
            'mosqueiro': 'PA',
            'braganca': 'PA',
            'monte_alegre': 'PA',
            'algodoal': 'PA',
            'obidos': 'PA',
            'parauapebas': 'PA',
            'castanhal': 'PA',
            'cameta': 'PA'
        };
        
        // CONFIG: Destinos que s√£o capitais/hubs (mant√©m local ponderado)
        const PULSE_IS_CAPITAL_OR_HUB = {
            'belem': true
        };
        
        // CONFIG: Redutor do peso local para capitais (40%)
        const PULSE_LOCAL_REDUCER_FOR_CAPITAL = 0.40;
        
        // CONFIG: Crit√©rios de validade
        const PULSE_MIN_ORIGENS = 3;          // diversidade m√≠nima
        const PULSE_DOMINANCE_LIMIT = 70;     // se 1 origem >70%, sinal fraco
        const PULSE_MIN_RECURRENCES = 2;      // recorr√™ncia m√≠nima
        const PULSE_LOOKBACK = 6;             // √∫ltimas N coletas
        
        /** Normaliza√ß√£o de nomes de estados */
        function pulseNormState(s) {
            if (!s) return '';
            return String(s)
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, ' ')
                .trim()
                .toUpperCase();
        }
        
        /** Extrai top 3 origens de 1 linha */
        function pulseExtractTop3(row) {
            const out = [];
            const pushIf = function(name, pct) {
                const n = pulseNormState(name);
                const p = Number(pct);
                if (!n || !Number.isFinite(p)) return;
                out.push({ state: n, pct: p });
            };
            pushIf(row.origem_1, row.origem_1_pct);
            pushIf(row.origem_2, row.origem_2_pct);
            pushIf(row.origem_3, row.origem_3_pct);
            return out.sort(function(a, b) { return b.pct - a.pct; });
        }
        
        /** Aplica corre√ß√£o do vi√©s local */
        function pulseAdjustLocalBias(destinoId, top3) {
            const localUF = pulseNormState(PULSE_LOCAL_UF_BY_DESTINO[destinoId] || '');
            const isCapital = !!PULSE_IS_CAPITAL_OR_HUB[destinoId];
            
            if (!localUF) return { adjusted: top3.slice(), localUF: localUF, mode: 'no_local_config' };
            
            if (!isCapital) {
                const filtered = top3.filter(function(x) { return x.state !== localUF; });
                return { adjusted: filtered, localUF: localUF, mode: 'local_removed' };
            }
            
            const adjusted = top3.map(function(x) {
                if (x.state === localUF) {
                    return { state: x.state, pct: Math.round(x.pct * PULSE_LOCAL_REDUCER_FOR_CAPITAL) };
                }
                return x;
            }).sort(function(a, b) { return b.pct - a.pct; });
            
            return { adjusted: adjusted, localUF: localUF, mode: 'local_pondered' };
        }
        
        /** Verifica se 1 coleta tem diversidade estat√≠stica m√≠nima */
        function pulseIsObservedValid(adjustedTop) {
            const n = adjustedTop.length;
            if (n < PULSE_MIN_ORIGENS) return false;
            const maxPct = adjustedTop[0] ? adjustedTop[0].pct : 0;
            if (maxPct >= PULSE_DOMINANCE_LIMIT) return false;
            return true;
        }
        
        /** Conta recorr√™ncia das origens nas √∫ltimas N coletas */
        function pulseRecurrence(destinoId, rows) {
            const last = rows.slice(-PULSE_LOOKBACK);
            const counts = new Map();
            
            for (let i = 0; i < last.length; i++) {
                const row = last[i];
                const top3 = pulseExtractTop3(row);
                const adjInfo = pulseAdjustLocalBias(destinoId, top3);
                const adjusted = adjInfo.adjusted;
                
                for (let j = 0; j < adjusted.length; j++) {
                    const x = adjusted[j];
                    counts.set(x.state, (counts.get(x.state) || 0) + 1);
                }
            }
            
            const arr = [];
            counts.forEach(function(n, state) {
                arr.push({ state: state, n: n });
            });
            
            arr.sort(function(a, b) { return b.n - a.n; });
            return arr;
        }
        
        /** Fun√ß√£o principal: devolve leitura Camada 2 para 1 destino */
        function pulseCamada2Compute(destinoId, rowsDoDestino) {
            const rows = Array.isArray(rowsDoDestino) ? rowsDoDestino : [];
            if (rows.length === 0) {
                return { 
                    mode: 'insuficiente', 
                    badge: 'Sem hist√≥rico', 
                    text: 'Sem dados suficientes para leitura de origem.' 
                };
            }
            
            const lastRow = rows[rows.length - 1];
            const top3 = pulseExtractTop3(lastRow);
            const adjInfo = pulseAdjustLocalBias(destinoId, top3);
            const adjusted = adjInfo.adjusted;
            
            if (adjusted.length === 0) {
                return {
                    mode: 'insuficiente',
                    badge: 'Baixo volume',
                    text: 'Origem n√£o observ√°vel (baixa diversidade no Trends).'
                };
            }
            
            const observedOk = pulseIsObservedValid(adjusted);
            const rec = pulseRecurrence(destinoId, rows);
            const topRec = rec[0];
            const isRecurring = topRec && topRec.n >= PULSE_MIN_RECURRENCES;
            
            if (observedOk) {
                const o1 = adjusted[0];
                const o2 = adjusted[1];
                const o3 = adjusted[2];
                
                const badge = isRecurring
                    ? 'Origem recorrente: ' + topRec.state + ' (' + topRec.n + '/' + Math.min(PULSE_LOOKBACK, rows.length) + ')'
                    : 'Origem observada (Top 3)';
                
                const textParts = [];
                textParts.push('Origem (Top 3 ajustado): ' + o1.state + ' ' + o1.pct + '%');
                if (o2) textParts.push(o2.state + ' ' + o2.pct + '%');
                if (o3) textParts.push(o3.state + ' ' + o3.pct + '%');
                if (isRecurring) textParts.push('‚Ä¢ Recorr√™ncia externa: ' + topRec.state + ' em ' + topRec.n + ' coletas recentes');
                if (adjInfo.mode === 'local_pondered') textParts.push('‚Ä¢ Local ponderado (capital/hub)');
                if (adjInfo.mode === 'local_removed') textParts.push('‚Ä¢ Local removido (vi√©s end√≥geno)');
                
                return { mode: 'observada', badge: badge, text: textParts.join(' | ') };
            }
            
            if (isRecurring) {
                return {
                    mode: 'inferida',
                    badge: '‚ö†Ô∏è Origem inferida: ' + topRec.state + ' (' + topRec.n + '/' + Math.min(PULSE_LOOKBACK, rows.length) + ')',
                    text: 'Baixa diversidade no Trends. Mercado mais recorrente nas √∫ltimas coletas: ' + topRec.state + '.'
                };
            }
            
            return {
                mode: 'insuficiente',
                badge: '‚ö†Ô∏è Baixa diversidade',
                text: 'Origem n√£o confi√°vel (poucos estados no Trends / domin√¢ncia alta). Aguarde mais coletas.'
            };
        }
        
        // ============================================================
        // FIM DA CAMADA 2
        // ============================================================
        
        // ========== FUN√á√ÉO PARA DETERMINAR COR DO MARKER ==========
        function getMarkerColor(interesse) {
            if (interesse >= 70) return '#ff3860'; // Vermelho
            if (interesse >= 40) return '#ffea00'; // Amarelo
            return '#39ff14'; // Verde
        }
        
        // ========== FUN√á√ïES DE C√ÅLCULO DE √çNDICES ==========
        
        /**
         * NOWCASTING: Previs√£o de interesse para pr√≥ximos 7 dias
         */
        function calcularNowcasting(destino, dadosHistoricos) {
            try {
                const historico = dadosHistoricos
                    .filter(d => d.destino_id === destino.destino_id)
                    .slice(0, 10)
                    .reverse();
                
                if (historico.length < 3) return null;
                
                const alpha = 0.3;
                let ema = historico[0].interesse;
                
                for (let i = 1; i < historico.length; i++) {
                    ema = alpha * historico[i].interesse + (1 - alpha) * ema;
                }
                
                const ultimo = historico[historico.length - 1].interesse;
                const penultimo = historico[historico.length - 2].interesse;
                const antepenultimo = historico[historico.length - 3].interesse;
                
                const tendencia = ((ultimo - penultimo) + (penultimo - antepenultimo)) / 2;
                const previsao = Math.max(0, Math.min(100, Math.round(ema + (tendencia * 0.5))));
                const direcao = tendencia > 1 ? '‚ÜóÔ∏è' : tendencia < -1 ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
                
                return { valor: previsao, direcao };
            } catch (error) {
                return null;
            }
        }
        
        /**
         * CONFIABILIDADE DO SINAL (0-100)
         */
        function calcularConfiabilidade(destino, dadosHistoricos) {
            try {
                const historico = dadosHistoricos
                    .filter(d => d.destino_id === destino.destino_id)
                    .slice(0, 5);
                
                if (historico.length < 3) {
                    return { score: null, nivel: 'Dados Insuficientes', classe: 'baixa' };
                }
                
                let consistencia = 0;
                if (historico.length >= 4) {
                    let direcoes = [];
                    for (let i = 0; i < historico.length - 1; i++) {
                        const diff = historico[i].interesse - historico[i+1].interesse;
                        direcoes.push(diff > 0 ? 1 : diff < 0 ? -1 : 0);
                    }
                    const positivas = direcoes.filter(d => d > 0).length;
                    const negativas = direcoes.filter(d => d < 0).length;
                    const maxConsistente = Math.max(positivas, negativas);
                    consistencia = (maxConsistente / direcoes.length) * 100;
                }
                
                const valores = historico.map(h => h.interesse);
                const media = valores.reduce((a,b) => a+b, 0) / valores.length;
                const variancia = valores.reduce((sum, v) => sum + Math.pow(v - media, 2), 0) / valores.length;
                const desvioPadrao = Math.sqrt(variancia);
                const estabilidade = Math.max(0, 100 - (desvioPadrao * 2));
                
                const origens = [
                    destino.origem_1_pct || 0,
                    destino.origem_2_pct || 0,
                    destino.origem_3_pct || 0
                ];
                const somaOrigens = origens.reduce((a, b) => a + b, 0);
                
                let diversificacao = 50;
                if (somaOrigens > 0) {
                    const proporcoes = origens.map(o => o / somaOrigens);
                    const hhi = proporcoes.reduce((sum, p) => sum + (p * p), 0);
                    diversificacao = Math.max(0, (1 - hhi) * 100);
                }
                
                const scoreConfianca = Math.round(
                    (consistencia * 0.4) + (estabilidade * 0.3) + (diversificacao * 0.3)
                );
                
                let nivel, classe;
                if (scoreConfianca >= 70) { nivel = 'üü¢ Alta'; classe = 'alta'; }
                else if (scoreConfianca >= 40) { nivel = 'üü° M√©dia'; classe = 'media'; }
                else { nivel = 'üî¥ Baixa'; classe = 'baixa'; }
                
                return { score: scoreConfianca, nivel, classe };
            } catch (error) {
                return { score: null, nivel: 'N/A', classe: 'baixa' };
            }
        }
        
        /**
         * √çndice de Press√£o de Demanda (IPD)
         */
        function calcularIPD(destino, dadosHistoricos, todosDestinos) {
            try {
                const variacao = destino.variacao || 0;
                const variacaoNorm = Math.min(Math.abs(variacao), 100);
                
                let aceleracao = 0;
                const historico = dadosHistoricos.filter(d => d.destino_id === destino.destino_id);
                if (historico.length >= 3) {
                    const var1 = historico[0].interesse - historico[1].interesse;
                    const var2 = historico[1].interesse - historico[2].interesse;
                    aceleracao = Math.abs(var1 - var2);
                }
                const aceleracaoNorm = Math.min(aceleracao * 2, 100);
                
                let concentracao = 0;
                const origens = [
                    destino.origem_1_pct || 0,
                    destino.origem_2_pct || 0,
                    destino.origem_3_pct || 0
                ];
                const somaOrigens = origens.reduce((a, b) => a + b, 0);
                if (somaOrigens > 0) {
                    const proporcoes = origens.map(o => o / somaOrigens);
                    concentracao = proporcoes.reduce((sum, p) => sum + (p * p), 0) * 100;
                }
                
                const ipd = (0.4 * variacaoNorm) + (0.3 * aceleracaoNorm) + (0.3 * concentracao);
                return Math.round(ipd);
            } catch (error) {
                return null;
            }
        }
        
        function calcularMomentum(destino, dadosHistoricos) {
            try {
                const historico = dadosHistoricos
                    .filter(d => d.destino_id === destino.destino_id)
                    .slice(0, 5);
                
                if (historico.length < 3) return "Dados Insuficientes";
                
                const ultimo = historico[0].interesse;
                const penultimo = historico[1].interesse;
                const antepenultimo = historico[2].interesse;
                
                const direcao = ultimo > penultimo && penultimo > antepenultimo ? 1 :
                               ultimo < penultimo && penultimo < antepenultimo ? -1 : 0;
                
                let somaVar = 0;
                for (let i = 0; i < historico.length - 1; i++) {
                    somaVar += Math.abs(historico[i].interesse - historico[i+1].interesse);
                }
                const velocidade = somaVar / (historico.length - 1);
                
                const valores = historico.map(h => h.interesse);
                const media = valores.reduce((a,b) => a+b, 0) / valores.length;
                const variancia = valores.reduce((sum, v) => sum + Math.pow(v - media, 2), 0) / valores.length;
                const consistencia = 100 - Math.min(Math.sqrt(variancia), 100);
                
                if (direcao === 1 && velocidade > 5 && consistencia > 60) return "üöÄ Forte";
                if (direcao === -1) return "üìâ Perdendo";
                return "‚ö° Moderado";
            } catch (error) {
                return "N/A";
            }
        }
        
        
        function calcularOportunidade(destino, todosDestinos) {
            try {
                // ==========================
                // M√âDIA PONDERADA (Peso = Interesse)
                // ==========================

                const itens = (todosDestinos || [])
                    .map(function(d) {
                        return {
                            variacao: Number(d.variacao),
                            peso: Number(d.interesse)
                        };
                    })
                    .filter(function(x) {
                        return Number.isFinite(x.variacao) && 
                               Number.isFinite(x.peso) && 
                               x.peso > 0;
                    });

                if (itens.length === 0) return null;

                const somaPesos = itens.reduce(function(sum, x) {
                    return sum + x.peso;
                }, 0);

                if (somaPesos === 0) return null;

                const mediaPonderada = itens.reduce(function(sum, x) {
                    return sum + (x.variacao * x.peso);
                }, 0) / somaPesos;

                const variacaoDestino = Number(destino.variacao);
                if (!Number.isFinite(variacaoDestino)) return null;
                if (mediaPonderada === 0) return null;

                return variacaoDestino / mediaPonderada;

            } catch (error) {
                return null;
            }
        }

        /**
         * IPCR FINAL (0-100) ‚Äî √≠ndice composto simples e interpret√°vel
         * Componentes (j√° existentes no painel):
         * - Varia√ß√£o (%), com travas anti-outlier
         * - Press√£o de Demanda (IPD, 0-100)
         * - Share PA (participa√ß√£o entre os 15 destinos)
         * - Momentum (qualitativo ‚Üí score)
         *
         * Pesos (simples de explicar):
         * Varia√ß√£o 40% | IPD 30% | Share 20% | Momentum 10%
         */
        function calcularIPCRFinal(destino, todosHistoricos, todosDestinosUltimos) {
            try {
                // Helpers locais (sem depend√™ncias externas)
                const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
                const toNum = (v) => {
                    const n = Number(v);
                    return Number.isFinite(n) ? n : null;
                };

                // 1) Varia√ß√£o (%): trava em -50%..+50% para evitar explos√£o
                const variacao = toNum(destino.variacao);
                const variacaoClamped = variacao === null ? null : clamp(variacao, -50, 50);
                const scoreVariacao = variacaoClamped === null ? 50 : Math.round(((variacaoClamped + 50) / 100) * 100); // 0..100

                // 2) IPD (0..100) j√° calculado
                const ipd = toNum(destino.ipd);
                const scoreIPD = ipd === null ? 50 : clamp(Math.round(ipd), 0, 100);

                // 3) Share PA (%): normaliza pelo maior share do dia (0..100)
                const share = toNum(destino.share);
                let scoreShare = 50;
                if (share !== null && Array.isArray(todosDestinosUltimos) && todosDestinosUltimos.length > 0) {
                    const shares = todosDestinosUltimos
                        .map(d => Number(d.share))
                        .filter(x => Number.isFinite(x) && x > 0);
                    const maxShare = shares.length ? Math.max.apply(null, shares) : 0;
                    if (maxShare > 0) {
                        scoreShare = clamp(Math.round((share / maxShare) * 100), 0, 100);
                    }
                }

                // 4) Momentum (qualitativo ‚Üí score simples)
                const mom = String(destino.momentum || '').toLowerCase();
                let scoreMomentum = 50;
                if (mom.includes('forte') || mom.includes('üöÄ')) scoreMomentum = 80;
                else if (mom.includes('moderado') || mom.includes('‚ö°')) scoreMomentum = 60;
                else if (mom.includes('perdendo') || mom.includes('üìâ')) scoreMomentum = 30;

                // √çndice composto (0..100)
                const ipcrFinal = Math.round(
                    (scoreVariacao * 0.40) +
                    (scoreIPD * 0.30) +
                    (scoreShare * 0.20) +
                    (scoreMomentum * 0.10)
                );

                return clamp(ipcrFinal, 0, 100);
            } catch (e) {
                return null;
            }
        }

                
        function calcularRisco(destino) {
            try {
                const origens = [
                    destino.origem_1_pct || 0,
                    destino.origem_2_pct || 0,
                    destino.origem_3_pct || 0
                ];
                
                const somaOrigens = origens.reduce((a, b) => a + b, 0);
                if (somaOrigens === 0) return "N/A";
                
                const proporcoes = origens.map(o => o / somaOrigens);
                const hhi = proporcoes.reduce((sum, p) => sum + (p * p), 0);
                
                if (hhi > 0.5) return "üî¥ Alto";
                if (hhi > 0.35) return "üü° M√©dio";
                return "üü¢ Baixo";
            } catch (error) {
                return "N/A";
            }
        }
        
        /**
         * CALCULAR IPCR (√çndice de Press√£o Comparativa Regional)
         * CORRE√á√ÉO: Agora SEMPRE retorna um objeto v√°lido, mesmo sem concorrentes
         */
        function calcularIPCR(destinoPA, dadosConcorrentesNacionais) {
            try {
                console.log(`üîç Calculando IPCR para ${destinoPA.destino_id}...`);
                
                const variacaoPA = parseFloat(destinoPA.variacao);
                if (isNaN(variacaoPA) || destinoPA.variacao === null || destinoPA.variacao === undefined) {
                    console.log('‚ö†Ô∏è Sem varia√ß√£o PA');
                    return {
                        ipcr: null,
                        status: '‚è∏Ô∏è Sem Dados de Varia√ß√£o',
                        classe: 'estavel',
                        variacaoPA: null,
                        mediaConcorrentes: null,
                        concorrentes: []
                    };
                }
                
                const concorrentes = MAPA_CONCORRENCIA[destinoPA.destino_id];
                
                // SE N√ÉO TEM CONCORRENTES MAPEADOS
                if (!concorrentes || concorrentes.length === 0) {
                    console.log(`‚ö†Ô∏è ${destinoPA.destino_id} n√£o tem concorrentes mapeados`);
                    
                    let status, classe;
                    if (variacaoPA > 10) {
                        status = 'üìà Crescimento Forte';
                        classe = 'ganhando';
                    } else if (variacaoPA < -10) {
                        status = 'üìâ Queda Acentuada';
                        classe = 'perdendo';
                    } else if (variacaoPA > 0) {
                        status = '‚úÖ Crescimento Moderado';
                        classe = 'ganhando';
                    } else {
                        status = '‚û°Ô∏è Est√°vel';
                        classe = 'estavel';
                    }
                    
                    return {
                        ipcr: null,
                        status: status,
                        classe: classe,
                        variacaoPA: variacaoPA,
                        mediaConcorrentes: null,
                        concorrentes: [],
                        semConcorrentes: true
                    };
                }
                
                // TEM CONCORRENTES - Buscar dados
                if (!dadosConcorrentesNacionais || dadosConcorrentesNacionais.length === 0) {
                    console.log('‚ö†Ô∏è Sem dados de concorrentes nacionais');
                    return {
                        ipcr: null,
                        status: '‚è∏Ô∏è Aguardando Dados Nacionais',
                        classe: 'estavel',
                        variacaoPA: variacaoPA,
                        mediaConcorrentes: null,
                        concorrentes: []
                    };
                }
                
                const ultimaData = dadosConcorrentesNacionais[0].data_coleta;
                const concorrentesData = dadosConcorrentesNacionais.filter(c => c.data_coleta === ultimaData);
                
                const variacoesConcorrentes = concorrentes
                    .map(concId => {
                        const historicoConc = dadosConcorrentesNacionais.filter(d => d.destino_id === concId);
                        if (historicoConc.length < 2) return null;
                        
                        const atual = historicoConc[0].interesse;
                        const anterior = historicoConc[1].interesse;
                        const variacao = anterior !== 0 ? ((atual - anterior) / anterior * 100) : 0;
                        
                        return {
                            id: concId,
                            nome: CONCORRENTES_INFO[concId]?.nome || concId,
                            variacao: variacao,
                            interesse: atual
                        };
                    })
                    .filter(v => v !== null);
                
                // Prote√ß√£o contra array vazio
                if (variacoesConcorrentes.length === 0) {
                    console.log('‚ö†Ô∏è Nenhum concorrente com dados v√°lidos');
                    return {
                        ipcr: null,
                        status: '‚è∏Ô∏è Dados Insuficientes',
                        classe: 'estavel',
                        variacaoPA: variacaoPA,
                        mediaConcorrentes: null,
                        concorrentes: []
                    };
                }
                
                const mediaConcorrentes = variacoesConcorrentes.reduce((sum, c) => sum + c.variacao, 0) / variacoesConcorrentes.length;
                
                // ========== L√ìGICA IPCR CORRIGIDA ==========
                let ipcr = null;
                let status, classe;
                
                if (mediaConcorrentes === 0) {
                    if (variacaoPA > 0)      { status = '‚úÖ Ganhando Competitividade'; classe = 'ganhando'; }
                    else if (variacaoPA < 0) { status = '‚ö†Ô∏è Perdendo Competitividade'; classe = 'perdendo'; }
                    else                     { status = '‚û°Ô∏è Est√°vel vs Concorrentes';  classe = 'estavel'; }
                }
                // Sinais opostos ‚Üí quem est√° positivo ganha
                else if (variacaoPA > 0 && mediaConcorrentes < 0) {
                    status = '‚úÖ Ganhando Competitividade'; classe = 'ganhando';
                }
                else if (variacaoPA < 0 && mediaConcorrentes > 0) {
                    status = '‚ö†Ô∏è Perdendo Competitividade'; classe = 'perdendo';
                }
                // Mesmo sinal ‚Üí raz√£o das magnitudes
                else {
                    const ratio = Math.abs(variacaoPA) / Math.abs(mediaConcorrentes);
                    ipcr = ratio;
                    
                    if (variacaoPA > 0) {
                        // Ambos positivos: ratio > 1.2 = PA sobe mais = ganhando
                        if (ratio > 1.2)      { status = '‚úÖ Ganhando Competitividade'; classe = 'ganhando'; }
                        else if (ratio < 0.8) { status = '‚ö†Ô∏è Perdendo Competitividade'; classe = 'perdendo'; }
                        else                  { status = '‚û°Ô∏è Est√°vel vs Concorrentes';  classe = 'estavel'; }
                    } else {
                        // Ambos negativos: ratio > 1.2 = PA cai mais = perdendo
                        if (ratio > 1.2)      { status = '‚ö†Ô∏è Perdendo Competitividade'; classe = 'perdendo'; }
                        else if (ratio < 0.8) { status = '‚úÖ Ganhando Competitividade'; classe = 'ganhando'; }
                        else                  { status = '‚û°Ô∏è Est√°vel vs Concorrentes';  classe = 'estavel'; }
                    }
                }
                
                console.log(`‚úÖ IPCR: ratio=${ipcr !== null ? ipcr.toFixed(2) : 'N/A'} | PA=${Number(variacaoPA).toFixed(1)}% | Conc=${Number(mediaConcorrentes).toFixed(1)}%`);
                
                return {
                    ipcr: ipcr,
                    status: status,
                    classe: classe,
                    variacaoPA: variacaoPA,
                    mediaConcorrentes: mediaConcorrentes,
                    concorrentes: variacoesConcorrentes
                };
            } catch (error) {
                console.error('‚ùå Erro ao calcular IPCR:', error);
                return {
                    ipcr: null,
                    status: '‚ùå Erro no C√°lculo',
                    classe: 'estavel',
                    variacaoPA: destinoPA.variacao || null,
                    mediaConcorrentes: null,
                    concorrentes: []
                };
            }
        }
        
        // ========== MATRIX BACKGROUND ==========
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const chars = '01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
        const fontSize = 14;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);
        
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00c6ff';
            ctx.font = `${fontSize}px monospace`;
            
            drops.forEach((y, i) => {
                const text = chars[Math.floor(Math.random() * chars.length)];
                const x = i * fontSize;
                ctx.fillText(text, x, y * fontSize);
                if (y * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            });
        }
        
        setInterval(drawMatrix, 50);
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // ========== INICIALIZAR MAPA ==========
        function inicializarMapa() {
            try {
                if (typeof L === 'undefined') {
                    console.error('‚ùå Leaflet n√£o carregado! Tentando novamente em 1s...');
                    setTimeout(inicializarMapa, 1000);
                    return;
                }
                
                console.log('üó∫Ô∏è Iniciando mapa...');
                
                if (mapInstance) {
                    console.log('Removendo inst√¢ncia anterior do mapa...');
                    mapInstance.remove();
                }
                
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('‚ùå Elemento #map n√£o encontrado no DOM!');
                    return;
                }
                
                mapInstance = L.map('map', {
                    center: [-3.5, -52.5],
                    zoom: 6,
                    zoomControl: true,
                    scrollWheelZoom: true
                });
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    className: 'map-tiles'
                }).addTo(mapInstance);
                
                mapElement.style.filter = 'brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) invert(1)';
                
                console.log('‚úÖ Mapa inicializado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar mapa:', error);
            }
        }
        
        // ========== RENDERIZAR MARKERS NO MAPA ==========
        function renderizarMapa(dados) {
            try {
                console.log('üó∫Ô∏è Renderizando mapa com dados...');
                
                if (!mapInstance) {
                    console.warn('‚ö†Ô∏è Mapa n√£o inicializado, tentando inicializar...');
                    inicializarMapa();
                    setTimeout(() => renderizarMapa(dados), 500);
                    return;
                }
                
                if (typeof L === 'undefined') {
                    console.error('‚ùå Leaflet n√£o dispon√≠vel ao renderizar markers!');
                    return;
                }
                
                mapInstance.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        mapInstance.removeLayer(layer);
                    }
                });
                
                const ultimaData = dados[0].data_coleta;
                const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);
                
                console.log(`üìç Adicionando ${dadosUltimos.length} markers ao mapa...`);
                
                let markersAdicionados = 0;
                dadosUltimos.forEach((dest, index) => {
                    const info = (DESTINOS_INFO[dest.destino_id] || { nome: dest.destino_id, emoji: 'üìç' });
                    if (!info || !info.lat || !info.lng) {
                        console.warn(`‚ö†Ô∏è Coordenadas ausentes para ${dest.destino_id}`);
                        return;
                    }
                    
                    const cor = getMarkerColor(dest.interesse);
                    
                    const customIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            background: ${cor};
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            border: 3px solid rgba(0, 0, 0, 0.5);
                            box-shadow: 0 0 15px ${cor}, 0 4px 10px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 14px;
                        ">${info.emoji}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const popupContent = `
                        <div class="popup-title">${info.emoji} ${info.nome}</div>
                        <div class="popup-metric"><strong>Interesse:</strong> ${dest.interesse}/100</div>
                        <div class="popup-metric"><strong>Ranking:</strong> #${index + 1} PA</div>
                        ${dest.origem_1 ? `
                            <div class="popup-origins">
                                <div class="popup-metric">ü•á ${dest.origem_1} (${dest.origem_1_pct}%)</div>
                                ${dest.origem_2 ? `<div class="popup-metric">ü•à ${dest.origem_2} (${dest.origem_2_pct}%)</div>` : ''}
                                ${dest.origem_3 ? `<div class="popup-metric">ü•â ${dest.origem_3} (${dest.origem_3_pct}%)</div>` : ''}
                            </div>
                        ` : ''}
                    `;
                    
                    L.marker([info.lat, info.lng], { icon: customIcon })
                        .addTo(mapInstance)
                        .bindPopup(popupContent);
                    
                    markersAdicionados++;
                });
                
                console.log(`‚úÖ ${markersAdicionados} markers adicionados ao mapa com sucesso!`);
            } catch (error) {
                console.error('‚ùå Erro ao renderizar mapa:', error);
            }
        }
        
        // ========== BUSCAR DADOS DO SUPABASE ==========
        async function buscarDados() {
            try {
                console.log('üîç Buscando dados do Supabase...');
                const { data, error } = await supabaseClient
                    .from('pulse_amazonia')
                    .select('*')
                    .order('data_coleta', { ascending: false })
                    .limit(300);
                
                if (error) {
                    console.error('‚ùå Erro Supabase:', error);
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum dado encontrado');
                    mostrarEstadoVazio();
                    return [];
                }
                
                console.log(`‚úÖ ${data.length} registros carregados (pulse_amazonia)`);
                return data;
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados:', error);
                mostrarErro('Erro ao conectar com banco de dados');
                return [];
            }
        }
        
        async function buscarDadosConcorrentes() {
            try {
                console.log('üîç Buscando dados de concorrentes nacionais...');
                const { data, error } = await supabaseClient
                    .from('concorrentes_nacionais')
                    .select('*')
                    .order('data_coleta', { ascending: false })
                    .limit(200);
                
                if (error) {
                    console.error('‚ùå Erro Supabase (concorrentes):', error);
                    return [];
                }
                
                if (!data || data.length === 0) {
                    console.warn('‚ö†Ô∏è Nenhum dado de concorrentes encontrado');
                    return [];
                }
                
                console.log(`‚úÖ ${data.length} registros de concorrentes carregados`);
                return data;
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados de concorrentes:', error);
                return [];
            }
        }
        
        // ========== PROCESSAR E RENDERIZAR ==========
        async function atualizarDados() {
            console.log('üîÑ Atualizando dados...');
            const dados = await buscarDados();
            const concorrentes = await buscarDadosConcorrentes();
            
            if (dados.length === 0) return;
            
            dadosGlobais = dados;
            dadosConcorrentes = concorrentes;
            
            renderizarCards(dados);
            renderizarTimeline(dados);
            renderizarMapa(dados);
            gerarBoletim(dados, concorrentes);
            renderizarCalendario();
            
            console.log('‚úÖ Dashboard atualizado com sucesso!');
        }
        
        // ========== GERAR BOLETIM POR DESTINO ==========
        function gerarBoletimDestino(destino, todosDestinos, concorrentes) {
            console.log(`üìä Gerando boletim para ${destino.destino_id}...`);
            
            const info = DESTINOS_INFO[destino.destino_id] || { nome: destino.destino_id, emoji: 'üìç' };
            const dataFormatada = new Date(destino.data_coleta).toLocaleDateString('pt-BR');
            
            const nowcasting = calcularNowcasting(destino, todosDestinos);
            const confiabilidade = calcularConfiabilidade(destino, todosDestinos);
            const momentum = calcularMomentum(destino, todosDestinos);
            const risco = calcularRisco(destino);
            
            // Calcular IPCR
            const ipcr = calcularIPCR(destino, concorrentes);
            console.log('IPCR retornado:', ipcr);
            console.log('üîç IPCR JSON COMPLETO:', JSON.stringify(ipcr, null, 2));
            
            // IPCR HTML - SEMPRE MOSTRAR ALGO
            let ipcrHTML = '';
            if (ipcr) {
                if (ipcr.variacaoPA === null) {
                    ipcrHTML = '<div class="boletim-section ipcr-section">' +
                        '<div class="boletim-section-title">üåç Competitividade Nacional (IPCR)</div>' +
                        '<div class="ipcr-item">' +
                        '<div class="ipcr-comparacao" style="font-size: 0.85rem; color: var(--text-dim);">‚è≥ Aguardando 2¬™ coleta para calcular varia√ß√£o</div>' +
                        '<div class="ipcr-status estavel">‚è∏Ô∏è Dados Insuficientes</div>' +
                        '</div></div>';
                } else if (ipcr.semConcorrentes) {
                    ipcrHTML = '<div class="boletim-section ipcr-section">' +
                        '<div class="boletim-section-title">üåç Performance Nacional</div>' +
                        '<div class="ipcr-item">' +
                        '<div class="ipcr-comparacao">Varia√ß√£o PA: ' + 
                        (ipcr.variacaoPA !== null ? (ipcr.variacaoPA >= 0 ? '+' : '') + Number(ipcr.variacaoPA).toFixed(1) + '%' : 'N/A') + '</div>' +
                        '<div class="ipcr-comparacao" style="font-size: 0.7rem; margin-top: 4px; color: var(--text-dim);">Sem concorrentes diretos mapeados</div>' +
                        '<div class="ipcr-status ' + ipcr.classe + '">' + ipcr.status + '</div>' +
                        '</div></div>';
                } else if (ipcr.concorrentes.length > 0) {
                    const principais = ipcr.concorrentes.slice(0, 3);
                    const indiceHTML = ipcr.ipcr !== null ? '<div class="ipcr-comparacao" style="margin-top: 4px;">√çndice: ' + ipcr.ipcr.toFixed(2) + '</div>' : '';
                    ipcrHTML = '<div class="boletim-section ipcr-section">' +
                        '<div class="boletim-section-title">üåç Competitividade Nacional (IPCR)</div>' +
                        '<div class="ipcr-item">' +
                        '<div class="ipcr-comparacao">PA: ' +
                        (ipcr.variacaoPA !== null ? (ipcr.variacaoPA >= 0 ? '+' : '') + Number(ipcr.variacaoPA).toFixed(1) + '%' : 'N/A') +
                        ' | Concorrentes: ' +
                        (ipcr.mediaConcorrentes !== null ? (ipcr.mediaConcorrentes >= 0 ? '+' : '') + Number(ipcr.mediaConcorrentes).toFixed(1) + '%' : 'N/A') +
                        '</div>' +
                        '<div class="ipcr-comparacao" style="font-size: 0.7rem; margin-top: 6px;">vs ' + principais.map(c => c.nome).join(', ') + '</div>' +
                        indiceHTML +
                        '<div class="ipcr-status ' + ipcr.classe + '">' + ipcr.status + '</div>' +
                        '</div></div>';
                } else {
                    ipcrHTML = '<div class="boletim-section ipcr-section">' +
                        '<div class="boletim-section-title">üåç Competitividade Nacional</div>' +
                        '<div class="ipcr-item">' +
                        '<div class="ipcr-comparacao">Varia√ß√£o PA: ' +
                        (ipcr.variacaoPA !== null ? (ipcr.variacaoPA >= 0 ? '+' : '') + Number(ipcr.variacaoPA).toFixed(1) + '%' : 'N/A') + '</div>' +
                        '<div class="ipcr-status ' + ipcr.classe + '">' + ipcr.status + '</div>' +
                        '</div></div>';
                }
            }
            
            // Calcular Camada 2 (Origem Ajustada)
            const historico = todosDestinos.filter(d => d.destino_id === destino.destino_id);
            const camada2 = pulseCamada2Compute(destino.destino_id, historico);
            console.log('üîç Camada 2 resultado:', camada2);
            
            // HTML Camada 2
            let camada2HTML = '';
            if (camada2.mode === 'observada' || camada2.mode === 'inferida') {
                const badgeClass = camada2.mode === 'observada' ? 'ganhando' : 'perdendo';
                camada2HTML = '<div class="boletim-section">' +
                    '<div class="boletim-section-title">üéØ Mercado Emissor (Camada 2)</div>' +
                    '<div class="ipcr-item">' +
                    '<div class="ipcr-status ' + badgeClass + '" style="font-size: 0.75rem; margin-bottom: 8px;">' + camada2.badge + '</div>' +
                    '<div class="ipcr-comparacao" style="font-size: 0.75rem; line-height: 1.4;">' + camada2.text + '</div>' +
                    '</div></div>';
            } else if (camada2.mode === 'insuficiente') {
                camada2HTML = '<div class="boletim-section">' +
                    '<div class="boletim-section-title">üéØ Mercado Emissor (Camada 2)</div>' +
                    '<div class="ipcr-item">' +
                    '<div class="ipcr-status estavel" style="font-size: 0.75rem; margin-bottom: 8px;">' + camada2.badge + '</div>' +
                    '<div class="ipcr-comparacao" style="font-size: 0.75rem; color: var(--text-dim);">' + camada2.text + '</div>' +
                    '</div></div>';
            }
            
            const html = `
                <div class="boletim-section">
                    <div class="boletim-section-title">${info.emoji} ${info.nome}</div>
                    <p style="font-size: 0.75rem; color: var(--text-dim);">${dataFormatada}</p>
                </div>
                <div class="boletim-section">
                    <div class="boletim-section-title">M√©tricas Principais</div>
                    <ul class="boletim-list">
                        <li>Interesse Atual: ${destino.interesse}/100</li>
                        ${destino.variacao !== null ? `<li>Varia√ß√£o: ${parseFloat(destino.variacao) >= 0 ? '+' : ''}${destino.variacao}%</li>` : ''}
                        ${nowcasting && nowcasting.valor !== null ? `<li>Previs√£o 7 dias: ${nowcasting.valor} ${nowcasting.direcao}</li>` : ''}
                        ${confiabilidade.score !== null ? `<li>Confiabilidade: ${confiabilidade.nivel} (${confiabilidade.score}/100)</li>` : ''}
                    </ul>
                </div>
                <div class="boletim-section">
                    <div class="boletim-section-title">‚ö° An√°lise Estrat√©gica</div>
                    <ul class="boletim-list">
                        <li>Momentum: ${momentum}</li>
                        <li>Risco de Mercado: ${risco}</li>
                        <li>IPCR Final (0-100): ${destino.ipcr_final !== null && destino.ipcr_final !== undefined ? (destino.ipcr_final + '/100') : 'N/A'}</li>
                        <li>Share PA: ${destino.share}%</li>
                    </ul>
                </div>
                ${destino.origem_1 ? `
                <div class="boletim-section">
                    <div class="boletim-section-title">Top 3 Origens (Bruto)</div>
                    <ul class="boletim-list">
                        <li>ü•á ${destino.origem_1} (${destino.origem_1_pct}%)</li>
                        ${destino.origem_2 ? `<li>ü•à ${destino.origem_2} (${destino.origem_2_pct}%)</li>` : ''}
                        ${destino.origem_3 ? `<li>ü•â ${destino.origem_3} (${destino.origem_3_pct}%)</li>` : ''}
                    </ul>
                </div>
                ` : ''}
                ${camada2HTML}
                ${ipcrHTML}
            `;
            
            console.log('üìù HTML length:', html.length);
            console.log('üìù ipcrHTML length:', ipcrHTML.length);
            console.log('üìù ipcrHTML content:', ipcrHTML || 'VAZIO');
            document.getElementById('boletim-content').innerHTML = html;
            console.log('‚úÖ Boletim gerado com sucesso');
        }
        
        // ========== RENDERIZAR CARDS ==========
        function renderizarCards(dados) {
            const container = document.getElementById('destinations-container');
            
            const ultimaData = dados[0].data_coleta;
            const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);
            
            const somaInteresse = dadosUltimos.reduce((sum, d) => sum + d.interesse, 0);
            
            const destinosProcessados = dadosUltimos.map(d => {
                const share = ((d.interesse / somaInteresse) * 100).toFixed(1);
                
                const coletas = dados.filter(dd => dd.destino_id === d.destino_id);
                let variacao = null;
                if (coletas.length > 1) {
                    const anterior = coletas[1].interesse;
                    variacao = anterior !== 0 ? ((d.interesse - anterior) / anterior * 100).toFixed(1) : 0;
                }
                
                return { ...d, share, variacao };
            });
            
            const destinosComIndices = destinosProcessados.map(dest => {
                const nowcasting = calcularNowcasting(dest, dados);
                const confiabilidade = calcularConfiabilidade(dest, dados);
                const ipd = calcularIPD(dest, dados, destinosProcessados);
                const momentum = calcularMomentum(dest, dados);
                const oportunidade = calcularOportunidade(dest, destinosProcessados);
                const risco = calcularRisco(dest);

                // IPCR Final (0-100) ‚Äî √≠ndice composto simples
                const ipcr_final = calcularIPCRFinal(
                    { ...dest, ipd, momentum },
                    dados,
                    destinosProcessados
                );

                return { ...dest, nowcasting, confiabilidade, ipd, momentum, oportunidade, risco, ipcr_final };
            });
            
            const destinosOrdenados = destinosComIndices.sort((a, b) => b.interesse - a.interesse);
            
            container.innerHTML = destinosOrdenados.map((dest, index) => {
                const info = DESTINOS_INFO[dest.destino_id] || { nome: dest.destino_id, emoji: 'üìç' };
                
                let ipdClass = 'neutral';
                let ipdLabel = 'Moderada';
                if (dest.ipd !== null) {
                    if (dest.ipd >= 70) { ipdClass = 'negative'; ipdLabel = 'üî¥ Alta'; }
                    else if (dest.ipd >= 40) { ipdClass = 'neutral'; ipdLabel = 'üü° Moderada'; }
                    else { ipdClass = 'positive'; ipdLabel = 'üü¢ Baixa'; }
                }
                
                let ipdDesc = '';
                if (dest.ipd !== null && dest.ipd >= 60) {
                    ipdDesc = dest.risco === 'üî¥ Alto' ? 'Crescimento concentrado em poucos mercados' : 'Crescimento acelerado com demanda distribu√≠da';
                } else if (dest.ipd !== null) {
                    ipdDesc = 'Demanda est√°vel';
                }
                
                let oportunidadeTexto = '';
                if (dest.oportunidade !== null && !isNaN(dest.oportunidade)) {
                    const mult = Math.abs(dest.oportunidade).toFixed(1);
                    if (dest.oportunidade > 1.5) {
                        oportunidadeTexto = `Crescendo ${mult}x mais r√°pido que m√©dia PA`;
                    } else if (dest.oportunidade < 0.5) {
                        oportunidadeTexto = `Crescendo ${mult}x mais devagar que m√©dia PA`;
                    } else {
                        oportunidadeTexto = `Crescimento pr√≥ximo √† m√©dia estadual`;
                    }
                }
                
                return `
                    <div class="dest-card" data-index="${index}">
                        <div class="dest-header">
                            <div class="dest-name">${info.emoji} ${info.nome}</div>
                            <div class="dest-rank">#${index + 1} PA</div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-label">Interesse Atual</div>
                            <div class="metric-value">${dest.interesse}/100</div>
                        </div>
                        
                        ${dest.nowcasting && dest.nowcasting.valor !== null ? `
                        <div class="metric-row">
                            <div class="metric-label">Previs√£o 7 dias</div>
                            <div class="metric-value ${dest.nowcasting.valor > dest.interesse ? 'positive' : dest.nowcasting.valor < dest.interesse ? 'negative' : 'neutral'}">
                                ${dest.nowcasting.valor} ${dest.nowcasting.direcao}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${dest.confiabilidade.score !== null ? `
                        <div class="metric-row">
                            <div class="metric-label">Confiabilidade</div>
                            <div class="metric-value">
                                ${dest.confiabilidade.nivel}
                                <span class="badge-confianca ${dest.confiabilidade.classe}">${dest.confiabilidade.score}/100</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${dest.variacao !== null ? `
                        <div class="metric-row">
                            <div class="metric-label">Varia√ß√£o</div>
                            <div class="metric-value ${parseFloat(dest.variacao) >= 0 ? 'positive' : 'negative'}">
                                ${parseFloat(dest.variacao) >= 0 ? '+' : ''}${dest.variacao}%
                            </div>
                        </div>
                        ` : ''}
                        
                        ${dest.ipd !== null ? `
                        <div class="indice-destaque">
                            <div class="indice-titulo">üíé Press√£o de Demanda</div>
                            <div class="indice-valor ${ipdClass}">${ipdLabel} (${dest.ipd}/100)</div>
                            ${ipdDesc ? `<div class="indice-descricao">${ipdDesc}</div>` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="metric-row">
                            <div class="metric-label">Momentum</div>
                            <div class="metric-value">${dest.momentum}</div>
                        </div>


                        ${dest.ipcr_final !== null && dest.ipcr_final !== undefined ? `
                        <div class="metric-row">
                            <div class="metric-label">IPCR Final</div>
                            <div class="metric-value ${dest.ipcr_final >= 70 ? 'positive' : dest.ipcr_final >= 40 ? 'neutral' : 'negative'}">
                                ${dest.ipcr_final}/100
                            </div>
                        </div>
                        ` : ''}
                        
                        ${oportunidadeTexto ? `
                        <div class="metric-row">
                            <div class="metric-label">Oportunidade</div>
                            <div class="metric-value" style="font-size: 0.8rem;">${oportunidadeTexto}</div>
                        </div>
                        ` : ''}
                        
                        <div class="metric-row">
                            <div class="metric-label">Risco de Mercado</div>
                            <div class="metric-value">${dest.risco}</div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-label">Share PA</div>
                            <div class="metric-value">${dest.share}%</div>
                        </div>
                        
                        ${dest.origem_1 ? `
                        <div class="origins-list">
                            <div class="origin-item">
                                <span class="origin-name">ü•á ${dest.origem_1}</span>
                                <span class="origin-pct">${dest.origem_1_pct}%</span>
                            </div>
                            ${dest.origem_2 ? `
                            <div class="origin-item">
                                <span class="origin-name">ü•à ${dest.origem_2}</span>
                                <span class="origin-pct">${dest.origem_2_pct}%</span>
                            </div>
                            ` : ''}
                            ${dest.origem_3 ? `
                            <div class="origin-item">
                                <span class="origin-name">ü•â ${dest.origem_3}</span>
                                <span class="origin-pct">${dest.origem_3_pct}%</span>
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // ADICIONAR EVENTOS DE CLIQUE NOS CARDS
            setTimeout(() => {
                document.querySelectorAll('.dest-card').forEach((card, index) => {
                    card.addEventListener('click', () => {
                        const destino = destinosOrdenados[index];
                        console.log(`üéØ Card clicado: ${destino.destino_id}`);
                        gerarBoletimDestino(destino, dados, dadosConcorrentes);
                        
                        // Scroll suave para o boletim em mobile
                        if (window.innerWidth <= 1200) {
                            document.querySelector('.boletim').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                });
            }, 100);
        }
        
        // ========== RENDERIZAR TIMELINE ==========
        function renderizarTimeline(dados) {
            const ultimaData = dados[0].data_coleta;
            const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);
            const top5 = dadosUltimos
                .sort((a, b) => b.interesse - a.interesse)
                .slice(0, 5)
                .map(d => d.destino_id);
            
            const datasetsData = {};
            top5.forEach(destId => {
                datasetsData[destId] = dados
                    .filter(d => d.destino_id === destId)
                    .reverse()
                    .slice(-18);
            });
            
            const labels = datasetsData[top5[0]].map(d => {
                const date = new Date(d.data_coleta);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            });
            
            const cores = ['#00c6ff', '#39ff14', '#ff3860', '#ffea00', '#9d4edd'];
            
            const datasets = top5.map((destId, i) => {
                const info = (DESTINOS_INFO[destId] || { nome: destId, emoji: 'üìç' });
                return {
                    label: info.nome,
                    data: datasetsData[destId].map(d => d.interesse),
                    borderColor: cores[i],
                    backgroundColor: cores[i] + '20',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            if (chartInstance) chartInstance.destroy();
            
            const ctxChart = document.getElementById('timeline-chart').getContext('2d');
            chartInstance = new Chart(ctxChart, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#eaf3ff', font: { size: 12, weight: 600 } }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 18, 22, 0.95)',
                            titleColor: '#00c6ff',
                            bodyColor: '#eaf3ff',
                            borderColor: '#00c6ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }
        
        // ========== GERAR BOLETIM GERAL (VIS√ÉO AGREGADA) ==========
        function gerarBoletim(dados, concorrentes) {
            const ultimaData = dados[0].data_coleta;
            const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);
            
            const top3 = dadosUltimos
                .sort((a, b) => b.interesse - a.interesse)
                .slice(0, 3)
                .map(d => {
                    const info = (DESTINOS_INFO[d.destino_id] || { nome: d.destino_id, emoji: 'üìç' });
                    return `${info.emoji} ${info.nome} (${d.interesse})`;
                });
            
            const origensMap = {};
            dadosUltimos.forEach(d => {
                if (d.origem_1) origensMap[d.origem_1] = (origensMap[d.origem_1] || 0) + d.origem_1_pct * d.interesse;
                if (d.origem_2) origensMap[d.origem_2] = (origensMap[d.origem_2] || 0) + d.origem_2_pct * d.interesse;
                if (d.origem_3) origensMap[d.origem_3] = (origensMap[d.origem_3] || 0) + d.origem_3_pct * d.interesse;
            });
            
            const topOrigens = Object.entries(origensMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([cidade]) => cidade);
            
            const dataFormatada = new Date(ultimaData).toLocaleDateString('pt-BR');
            
            const html = `
                <div class="boletim-section">
                    <div class="boletim-section-title">Data: ${dataFormatada}</div>
                </div>
                <div class="boletim-section">
                    <div class="boletim-section-title">üèÜ Top 3 Destinos PA</div>
                    <ul class="boletim-list">
                        ${top3.map(t => `<li>${t}</li>`).join('')}
                    </ul>
                </div>
                <div class="boletim-section">
                    <div class="boletim-section-title">Top 3 Origens Agregadas</div>
                    <ul class="boletim-list">
                        ${topOrigens.map(o => `<li>${o}</li>`).join('')}
                    </ul>
                </div>
                <div class="boletim-section">
                    <div class="boletim-section-title">Insights</div>
                    <p>Total de ${dadosUltimos.length} destinos monitorados. Fontes p√∫blicas + modelagem propriet√°ria ABR.</p>
                    <p style="margin-top: 8px; font-size: 0.75rem;"><strong>Dica:</strong> Clique em qualquer card de destino para ver an√°lise detalhada com IPCR!</p>
                </div>
            `;
            
            document.getElementById('boletim-content').innerHTML = html;
        }
        
        function copiarBoletim() {
            const content = document.getElementById('boletim-content').innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('‚úÖ Boletim copiado para √°rea de transfer√™ncia!');
            });
        }
        
        // ========== CALEND√ÅRIO ==========
        function renderizarCalendario() {
            const ano = mesAtual.getFullYear();
            const mes = mesAtual.getMonth();
            
            const nomeMes = mesAtual.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('calendar-month').textContent = nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1);
            
            const primeiroDia = new Date(ano, mes, 1).getDay();
            const ultimoDia = new Date(ano, mes + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].forEach(dia => {
                const label = document.createElement('div');
                label.className = 'calendar-day-label';
                label.textContent = dia;
                grid.appendChild(label);
            });
            
            for (let i = 0; i < primeiroDia; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day disabled';
                grid.appendChild(empty);
            }
            
            for (let dia = 1; dia <= ultimoDia; dia++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = dia;
                
                const dataStr = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const temDados = dadosGlobais.some(d => d.data_coleta === dataStr);
                
                if (temDados) dayEl.classList.add('has-data');
                
                grid.appendChild(dayEl);
            }
        }
        
        function navegarMes(direcao) {
            mesAtual.setMonth(mesAtual.getMonth() + direcao);
            renderizarCalendario();
        }
        
        function mostrarEstadoVazio() {
            document.getElementById('destinations-container').innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-state-icon">üå¥</div>
                    <p>Nenhum dado dispon√≠vel ainda.<br>Aguardando primeira coleta...</p>
                </div>
            `;
        }
        
        function mostrarErro(msg) {
            document.getElementById('destinations-container').innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>${msg}</p>
                </div>
            `;
        }
        
        // ========== INICIALIZA√á√ÉO ==========
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Inicializando PULSE AMAZ√îNIA...');
            inicializarMapa();
            atualizarDados();
        });
        
        document.getElementById('period-select').addEventListener('change', (e) => {
            const customDates = document.getElementById('custom-dates');
            customDates.style.display = e.target.value === 'custom' ? 'flex' : 'none';
        });
    </script>

<script>
// ===============================
// EDI√á√ÉO 4 ‚Äî EFEITO UAU
// 1) Ranking Hist√≥rico Simplificado
// 3) Selo Estrat√©gico Autom√°tico
// ===============================

function calcularRankingHistorico(destinoId, dados) {
    const historico = dados.filter(d => d.destino_id === destinoId);
    if (historico.length < 5) return null;

    const media = historico.slice(0, 5).reduce((sum, d) => sum + d.interesse, 0) / 5;
    return Math.round(media);
}

function gerarSeloEstrategico(destino) {
    if (!destino.variacao) return "‚öñÔ∏è Est√°vel";

    const v = parseFloat(destino.variacao);
    if (v >= 15) return "üöÄ Destino em Explos√£o";
    if (v >= 5) return "üìà Tend√™ncia de Alta";
    if (v <= -15) return "‚ö†Ô∏è Queda Relevante";
    if (v < 0) return "üìâ Ajuste de Demanda";
    return "‚öñÔ∏è Est√°vel";
}

// Override leve do render de cards (sem alterar estrutura principal)
const _renderizarCardsOriginal = renderizarCards;
renderizarCards = function(dados) {
    _renderizarCardsOriginal(dados);

    const ultimaData = dados[0].data_coleta;
    const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);

    document.querySelectorAll('.dest-card').forEach((card, index) => {
        const destino = dadosUltimos.sort((a,b)=>b.interesse-a.interesse)[index];
        if (!destino) return;

        const rankingHist = calcularRankingHistorico(destino.destino_id, dados);
        const selo = gerarSeloEstrategico(destino);

        const extraHTML = document.createElement('div');
        extraHTML.style.marginTop = "12px";
        extraHTML.style.paddingTop = "10px";
        extraHTML.style.borderTop = "1px solid rgba(255,255,255,0.05)";
        extraHTML.style.fontSize = "0.75rem";
        extraHTML.style.opacity = "0.85";

        extraHTML.innerHTML = `
            ${rankingHist ? `<div>M√©dia 5 coletas: <strong>${rankingHist}</strong></div>` : ''}
            <div style="margin-top:4px;">${selo}</div>
        `;

        card.appendChild(extraHTML);
    });
};
</script>

</body>
</html>
