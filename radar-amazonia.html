<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEMAND PULSE AMAZÔNIA – ABR Consultoria</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* === ESTILO PRESERVADO === */
body{margin:0;background:#000;color:#eaf3ff;font-family:Poppins}
h1{color:#00c6ff;text-align:center}
#map{height:420px;border-radius:14px}
.card{background:#0f1216cc;border-radius:14px;padding:14px;margin-bottom:12px}
</style>
</head>

<body>
<h1>DEMAND PULSE AMAZÔNIA</h1>
<div id="map"></div>
<canvas id="chart" height="120"></canvas>
<div id="cards"></div>

<script>
/* ================== CONFIG SUPABASE ================== */
const SUPABASE_URL = 'https://ljeoxnxezjmfbqngoqxz.supabase.co';
const SUPABASE_KEY = 'sb_publishable_3omH8_Hx47S3AlmGOoycpw_Etp5P7Nh';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== DESTINOS ================== */
const DESTINOS_INFO = {
  belem:{nome:'Belém',lat:-1.45,lng:-48.48},
  santarem:{nome:'Santarém',lat:-2.44,lng:-54.71},
  alter_do_chao:{nome:'Alter do Chão',lat:-2.50,lng:-54.95},
  salinopolis:{nome:'Salinópolis',lat:-0.61,lng:-47.35},
  castanhal:{nome:'Castanhal',lat:-1.29,lng:-47.92},
  parauapebas:{nome:'Parauapebas',lat:-6.06,lng:-49.90}
};

/* ================== MAPA ================== */
const map=L.map('map').setView([-3.5,-52.5],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ================== BUSCA DADOS ================== */
async function carregar(){
  const {data,error}=await supabaseClient
    .from('pulse_amazonia')
    .select('*')
    .order('data_coleta',{ascending:false})
    .limit(60);

  if(error){console.error(error);return}
  renderizar(data);
}
/* ================== RENDER ================== */
function renderizar(registros){
  const cards=document.getElementById('cards');
  cards.innerHTML='';

  const agregados={};
  registros.forEach(r=>{
    const id=r.destino_id;
    if(!DESTINOS_INFO[id]) return;
    if(!agregados[id]) agregados[id]={total:0,count:0};
    agregados[id].total+=Number(r.interesse)||0;
    agregados[id].count++;
  });

  const labels=[],valores=[];
  Object.keys(agregados).forEach(id=>{
    const media=Math.round(agregados[id].total/agregados[id].count);
    labels.push(DESTINOS_INFO[id].nome);
    valores.push(media);

    L.circleMarker(
      [DESTINOS_INFO[id].lat,DESTINOS_INFO[id].lng],
      {radius:6,color:'#00c6ff'}
    ).addTo(map)
     .bindPopup(`<b>${DESTINOS_INFO[id].nome}</b><br>Interesse médio: ${media}`);

    const c=document.createElement('div');
    c.className='card';
    c.innerHTML=`<b>${DESTINOS_INFO[id].nome}</b><br>Interesse médio: ${media}`;
    cards.appendChild(c);
  });

  new Chart(document.getElementById('chart'),{
    type:'bar',
    data:{labels,datasets:[{data:valores}]},
    options:{plugins:{legend:{display:false}}}
  });
}

/* ================== START ================== */
carregar();
</script>
</body>
</html>
