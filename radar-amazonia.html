<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DEMAND PULSE AMAZÔNIA — ABR</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Fira+Code&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --accent:#00c6ff;--bg:#000;--panel:rgba(15,18,22,.75);
  --border:rgba(255,255,255,.1);--txt:#eaf3ff;--dim:#9ca3af
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--txt);font-family:Poppins,sans-serif}
.container{max-width:1400px;margin:auto;padding:20px}
header{text-align:center;margin-bottom:30px}
h1{color:var(--accent);font-weight:800}
.subtitle{color:var(--dim)}
.panel{background:var(--panel);border:1px solid var(--border);
border-radius:20px;padding:20px;margin-bottom:20px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
.card{background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:16px;padding:14px}
.card h3{font-size:.9rem;color:var(--accent)}
.card span{font-size:1.4rem;font-weight:700}
pre{white-space:pre-wrap;font-family:'Fira Code',monospace;color:#bcdcff}
canvas{width:100%;height:360px}
</style>
</head>

<body>
<div class="container">
  <header>
    <h1>DEMAND PULSE AMAZÔNIA</h1>
    <p class="subtitle">Radar de Inteligência Turística — 15 destinos</p>
  </header>

  <section class="panel">
    <canvas id="chart"></canvas>
  </section>

  <section class="cards" id="cards"></section>

  <section class="panel">
    <pre id="boletim"></pre>
  </section>
</div>

<script>
/* ========= SUPABASE ========= */
const supabase = window.supabase.createClient(
  'https://jeoxnzjmfbgnoqqxz.supabase.co',
  'sb_publishable_3omH8_Hx47S3AlmGOoycpw_Etp5P7Nh'
);

/* ========= ESTADO ========= */
let RAW = [];
let BY_DEST = {};

/* ========= FETCH ========= */
async function fetchData(){
  const { data, error } = await supabase
    .from('pulse_amazonia')
    .select('*');

  if(error){
    console.error(error);
    return;
  }
  RAW = data || [];
  normalize();
}

/* ========= NORMALIZA ========= */
function normalize(){
  BY_DEST = {};
  RAW.forEach(r=>{
    if(!BY_DEST[r.destino_id]){
      BY_DEST[r.destino_id]={nome:r.destino_nome,series:[]};
    }
    BY_DEST[r.destino_id].series.push({
      data:r.data_coleta,
      valor:r.interesse
    });
  });
}

/* ========= CHART ========= */
function renderChart(){
  const destinos = Object.values(BY_DEST);
  if(!destinos.length) return;

  const labels = destinos[0].series.map(s=>s.data);
  const colors = ['#00c6ff','#39ff14','#ff3131','#ffea00','#ff00ff'];

  const datasets = destinos.slice(0,5).map((d,i)=>({
    label:d.nome,
    data:d.series.map(s=>s.valor),
    borderColor:colors[i],
    tension:.3
  }));

  new Chart(document.getElementById('chart'),{
    type:'line',
    data:{labels,datasets},
    options:{responsive:true,maintainAspectRatio:false}
  });
}

/* ========= CARDS ========= */
function renderCards(){
  const el=document.getElementById('cards');
  el.innerHTML='';
  Object.values(BY_DEST).forEach(d=>{
    const last=d.series.at(-1);
    el.innerHTML+=`
      <div class="card">
        <h3>${d.nome}</h3>
        <span>${last.valor.toFixed(1)}</span>
      </div>`;
  });
}

/* ========= BOLETIM ========= */
function renderBoletim(){
  let txt='BOLETIM ESTRATÉGICO\n\n';
  Object.values(BY_DEST).forEach(d=>{
    const last=d.series.at(-1);
    txt+=${d.nome}: ${last.valor.toFixed(1)} pts\n;
  });
  document.getElementById('boletim').innerText=txt;
}

/* ========= START ========= */
async function start(){
  await fetchData();
  renderChart();
  renderCards();
  renderBoletim();
}
document.addEventListener('DOMContentLoaded',start);
</script>
</body>
</html>