<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå¥ DEMAND PULSE AMAZ√îNIA - ABR Consultoria</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/supabase-js@2"></script>
    
    <style>
        /* ========== RESET & VARI√ÅVEIS ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Poppins', sans-serif; overflow-x: hidden; min-height: 100vh; }
        
        :root {
            --accent: #00c6ff; --bg: #000000; --panel: rgba(15, 18, 22, 0.75); --panel-border: rgba(255, 255, 255, 0.1); --text-main: #eaf3ff; --text-dim: #9ca3af; --accent-green: #39ff14;
            --shadow: 0 8px 32px rgba(0, 198, 255, 0.15); --glow: 0 0 20px rgba(0, 198, 255, 0.4);
        }
        
        /* ========== MATRIX BACKGROUND ========== */
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.3; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }
        
        /* ========== HEADER ========== */
        .header { text-align: center; margin-bottom: 40px; padding-top: 20px; position: relative; }
        .header-nav { position: absolute; top: 20px; left: 0; display: flex; gap: 10px; z-index: 10; }
        .btn-nav { border: 1px solid var(--accent); padding: 8px 16px; border-radius: 999px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.3s; text-transform: uppercase; background: transparent; color: var(--accent); text-decoration: none; display: inline-block; }
        .btn-nav:hover { background: rgba(0,198,255,0.15); box-shadow: 0 0 20px rgba(0, 198, 255, 0.4); }
        
        h1 { font-size: 3.6rem; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }
        .subtitle { color: var(--text-dim); font-size: 0.9rem; max-width: 800px; margin: 0 auto; line-height: 1.5; font-weight: 400; }
        
        /* ========== LAYOUT GRID ========== */
        .layout { display: flex; gap: 20px; align-items: flex-start; }
        .main-content { flex: 1; }
        .sidebar { width: 380px; position: sticky; top: 20px; }
        
        /* ========== CONTROLS ========== */
        .controls { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 24px; margin-bottom: 30px; backdrop-filter: blur(14px); box-shadow: var(--shadow); }
        .date-filter-group { display: flex; flex-wrap: wrap; gap: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--panel-border); margin-bottom: 15px; align-items: center; }
        .filter-label { font-size: 0.7rem; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        select, input[type="date"] { background: rgba(0,0,0,0.4); border: 1px solid var(--panel-border); color: white; padding: 10px; border-radius: 10px; font-size: 0.8rem; cursor: pointer; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        .btn-update { width: 100%; background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); color: #001018; border: none; padding: 14px; border-radius: 14px; font-weight: 800; cursor: pointer; font-size: 1rem; transition: 0.3s; text-transform: uppercase; }
        .btn-update:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,198,255,0.4); }
        
        /* ========== STATUS INDICATOR ========== */
        .status-indicator { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-left: 10px; }
        .status-demo { background: rgba(255, 234, 0, 0.2); color: #ffea00; border: 1px solid #ffea00; }
        
        /* ========== TIMELINE CHART ========== */
        .timeline-section { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(14px); box-shadow: var(--shadow); }
        .section-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 20px; color: var(--accent); display: flex; align-items: center; gap: 12px; }
        .chart-wrapper { position: relative; height: 400px; }
        
        /* ========== DESTINATION CARDS ========== */
        .destinations-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dest-card { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 16px; padding: 20px; backdrop-filter: blur(14px); transition: 0.3s; cursor: pointer; }
        .dest-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,198,255,0.25); border-color: var(--accent); }
        
        .dest-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .dest-name { font-size: 1.1rem; font-weight: 600; color: var(--accent); }
        .dest-rank { background: rgba(0,198,255,0.2); color: var(--accent); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; }
        
        .metric-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-value { font-size: 1rem; font-weight: 700; color: white; }
        .metric-value.positive { color: #39ff14; }
        .metric-value.negative { color: #ff3860; }
        
        .origins-list { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
        .origin-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 0.85rem; }
        .origin-name { color: var(--text-dim); }
        .origin-pct { color: var(--accent); font-weight: 600; }
        
        /* ========== BOLETIM ESTRAT√âGICO ========== */
        .boletim { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 24px; backdrop-filter: blur(14px); box-shadow: var(--shadow); margin-bottom: 20px; }
        .boletim-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .boletim-title { font-size: 1.2rem; font-weight: 800; color: var(--accent); }
        .btn-copy { background: rgba(0,198,255,0.1); border: 1px solid var(--accent); color: var(--accent); padding: 8px 16px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-copy:hover { background: rgba(0,198,255,0.2); }
        
        .boletim-content { font-size: 0.85rem; line-height: 1.7; color: var(--text-dim); }
        .boletim-section { margin-bottom: 16px; }
        .boletim-section-title { font-weight: 700; color: white; margin-bottom: 8px; font-size: 0.9rem; }
        .boletim-list { list-style: none; padding-left: 0; }
        .boletim-list li { padding-left: 16px; position: relative; margin-bottom: 6px; }
        .boletim-list li:before { content: "‚ñ∏"; position: absolute; left: 0; color: var(--accent); font-weight: 800; }
        
        /* ========== CALEND√ÅRIO ========== */
        .calendar-section { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 20px; padding: 24px; backdrop-filter: blur(14px); box-shadow: var(--shadow); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-month { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
        .calendar-nav { display: flex; gap: 8px; }
        .btn-cal-nav { background: rgba(0,198,255,0.1); border: 1px solid var(--panel-border); color: var(--accent); width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-cal-nav:hover { background: rgba(0,198,255,0.2); border-color: var(--accent); }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-day-label { text-align: center; font-size: 0.7rem; font-weight: 700; color: var(--text-dim); padding: 8px 0; text-transform: uppercase; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.3); border: 1px solid var(--panel-border); border-radius: 10px; font-size: 0.85rem; cursor: pointer; transition: 0.2s; position: relative; }
        .calendar-day:hover { background: rgba(0,198,255,0.1); border-color: var(--accent); }
        .calendar-day.disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }
        .calendar-day.selected { background: var(--accent); color: #001018; font-weight: 800; border-color: var(--accent); }
        .calendar-day.has-data:after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--accent-green); border-radius: 50%; }
        
        /* ========== DICION√ÅRIO DE KPIs ========== */
        .kpi-dict { background: var(--panel); border: 1px solid var(--panel-border); border-radius: 16px; padding: 20px; backdrop-filter: blur(14px); box-shadow: var(--shadow); margin-top: 20px; }
        .kpi-dict-title { font-size: 1rem; font-weight: 700; color: var(--accent); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .kpi-item { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .kpi-item:last-child { border-bottom: none; }
        .kpi-name { font-size: 0.85rem; font-weight: 700; color: white; margin-bottom: 4px; }
        .kpi-desc { font-size: 0.75rem; color: var(--text-dim); line-height: 1.5; }
        
        /* ========== LOADING & EMPTY STATES ========== */
        .loading { text-align: center; padding: 60px 20px; color: var(--text-dim); }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(0,198,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
        
        /* ========== RESPONSIVIDADE ========== */
        @media (max-width: 1200px) {
            .layout { flex-direction: column; }
            .sidebar { width: 100%; position: static; }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .destinations-grid { grid-template-columns: 1fr; }
            .header-nav { position: static; justify-content: center; margin-bottom: 20px; }
        }
    </style>
</head>
<body>
    <!-- Matrix Background Canvas -->
    <canvas id="matrix-canvas"></canvas>
    
    <div class="container">
        <!-- HEADER -->
        <header class="header">
            <div class="header-nav">
                <a href="index.html" class="btn-nav">‚Üê Voltar ao HUB</a>
            </div>
            <h1>üå¥ DEMAND PULSE AMAZ√îNIA</h1>
            <p class="subtitle">
                Radar de Intelig√™ncia Tur√≠stica do Par√° - Monitoramento de 15 destinos amaz√¥nicos
                <span class="status-indicator status-demo">üé≠ MODO DEMO</span>
            </p>
        </header>
        
        <div class="layout">
            <!-- MAIN CONTENT -->
            <div class="main-content">
                <!-- CONTROLS -->
                <section class="controls">
                    <div class="date-filter-group">
                        <div>
                            <div class="filter-label">üìÖ Per√≠odo</div>
                            <select id="period-select">
                                <option value="7">√öltimos 7 dias</option>
                                <option value="14">√öltimos 14 dias</option>
                                <option value="30" selected>√öltimos 30 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div id="custom-dates" style="display: none;">
                            <input type="date" id="date-start" />
                            <input type="date" id="date-end" />
                        </div>
                    </div>
                    <button class="btn-update" onclick="atualizarDados()">üîÑ ATUALIZAR DADOS</button>
                </section>
                
                <!-- TIMELINE CHART -->
                <section class="timeline-section">
                    <h2 class="section-title">üìà Timeline Comparativa - Top 5 Destinos</h2>
                    <div class="chart-wrapper">
                        <canvas id="timeline-chart"></canvas>
                    </div>
                </section>
                
                <!-- DESTINATION CARDS -->
                <div id="destinations-container" class="destinations-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
            
            <!-- SIDEBAR -->
            <aside class="sidebar">
                <!-- BOLETIM ESTRAT√âGICO -->
                <section class="boletim">
                    <div class="boletim-header">
                        <h3 class="boletim-title">üìä Boletim Estrat√©gico</h3>
                        <button class="btn-copy" onclick="copiarBoletim()">üìã Copiar</button>
                    </div>
                    <div class="boletim-content" id="boletim-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <p>Aguardando dados para gerar boletim...</p>
                        </div>
                    </div>
                </section>
                
                <!-- CALEND√ÅRIO -->
                <section class="calendar-section">
                    <div class="calendar-header">
                        <div class="calendar-month" id="calendar-month">Janeiro 2026</div>
                        <div class="calendar-nav">
                            <button class="btn-cal-nav" onclick="navegarMes(-1)">‚óÄ</button>
                            <button class="btn-cal-nav" onclick="navegarMes(1)">‚ñ∂</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid"></div>
                </section>
                
                <!-- DICION√ÅRIO KPIs -->
                <section class="kpi-dict">
                    <h3 class="kpi-dict-title">üìñ Dicion√°rio de KPIs</h3>
                    <div class="kpi-item">
                        <div class="kpi-name">Interesse (0-100)</div>
                        <div class="kpi-desc">√çndice de pesquisa relativo do Google Trends. 100 = pico de buscas.</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-name">Varia√ß√£o %</div>
                        <div class="kpi-desc">Mudan√ßa percentual em rela√ß√£o √† coleta anterior.</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-name">Share de Mercado PA</div>
                        <div class="kpi-desc">Participa√ß√£o relativa entre os 15 destinos monitorados.</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-name">Top 3 Origens</div>
                        <div class="kpi-desc">Cidades brasileiras com maior interesse no destino.</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-name">Ranking Estadual</div>
                        <div class="kpi-desc">Posi√ß√£o do destino entre os 15 monitorados (#1 PA at√© #15 PA).</div>
                    </div>
                </section>
            </aside>
        </div>
    </div>
    
    <script>
        // ========== CONFIGURA√á√ÉO SUPABASE ========== ‚úÖ CORRIGIDO
        const SUPABASE_URL = 'https://ljeoxnxezjmfbqngoqxz.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_3omH8_Hx47S3AlmGOoycpw_Etp5P7Nh';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let dadosGlobais = [];
        let chartInstance = null;
        let mesAtual = new Date();
        
        const DESTINOS_INFO = {
            'belem': { nome: 'Bel√©m', emoji: 'üèôÔ∏è' },
            'alter_do_chao': { nome: 'Alter do Ch√£o', emoji: 'üèñÔ∏è' },
            'ilha_marajo': { nome: 'Ilha de Maraj√≥', emoji: 'üêÉ' },
            'santarem': { nome: 'Santar√©m', emoji: '‚õµ' },
            'salinopolis': { nome: 'Salin√≥polis', emoji: 'üåä' },
            'soure': { nome: 'Soure', emoji: 'ü¶©' },
            'salvaterra': { nome: 'Salvaterra', emoji: 'üå¥' },
            'mosqueiro': { nome: 'Mosqueiro', emoji: 'üèùÔ∏è' },
            'braganca': { nome: 'Bragan√ßa', emoji: 'ü¶Ä' },
            'monte_alegre': { nome: 'Monte Alegre', emoji: 'üóª' },
            'algodoal': { nome: 'Algodoal', emoji: 'ü••' },
            'obidos': { nome: '√ìbidos', emoji: 'üè∞' },
            'cameta': { nome: 'Camet√°', emoji: 'üé£' },
            'parauapebas': { nome: 'Parauapebas', emoji: '‚õèÔ∏è' },
            'castanhal': { nome: 'Castanhal', emoji: 'üå∞' }
        };
        
        // ========== MATRIX BACKGROUND ==========
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const chars = '01„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥';
        const fontSize = 14;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);
        
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00c6ff';
            ctx.font = `${fontSize}px monospace`;
            
            drops.forEach((y, i) => {
                const text = chars[Math.floor(Math.random() * chars.length)];
                const x = i * fontSize;
                ctx.fillText(text, x, y * fontSize);
                if (y * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            });
        }
        
        setInterval(drawMatrix, 50);
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        
        // ========== BUSCAR DADOS DO SUPABASE ==========
        async function buscarDados() {
            try {
                const { data, error } = await supabase
                    .from('pulse_amazonia')
                    .select('*')
                    .order('data_coleta', { ascending: false })
                    .limit(300);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    mostrarEstadoVazio();
                    return [];
                }
                
                return data;
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                mostrarErro('Erro ao conectar com banco de dados');
                return [];
            }
        }
        
        // ========== PROCESSAR E RENDERIZAR ==========
        async function atualizarDados() {
            const dados = await buscarDados();
            
            if (dados.length === 0) return;
            
            dadosGlobais = dados;
            
            // Renderizar cards
            renderizarCards(dados);
            
            // Renderizar timeline
            renderizarTimeline(dados);
            
            // Gerar boletim
            gerarBoletim(dados);
            
            // Atualizar calend√°rio
            renderizarCalendario();
        }
        
        // ========== RENDERIZAR CARDS ==========
        function renderizarCards(dados) {
            const container = document.getElementById('destinations-container');
            
            // Pegar √∫ltima coleta
            const ultimaData = dados[0].data_coleta;
            const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);
            
            // Calcular share de mercado
            const somaInteresse = dadosUltimos.reduce((sum, d) => sum + d.interesse, 0);
            
            // Ordenar por interesse
            const destinosOrdenados = dadosUltimos
                .map(d => {
                    const share = ((d.interesse / somaInteresse) * 100).toFixed(1);
                    return { ...d, share };
                })
                .sort((a, b) => b.interesse - a.interesse);
            
            // Gerar HTML
            container.innerHTML = destinosOrdenados.map((dest, index) => {
                const info = DESTINOS_INFO[dest.destino_id] || { nome: dest.destino_id, emoji: 'üìç' };
                
                // Calcular varia√ß√£o (se existir coleta anterior)
                const coletas = dados.filter(d => d.destino_id === dest.destino_id);
                let variacao = null;
                if (coletas.length > 1) {
                    const anterior = coletas[1].interesse;
                    variacao = ((dest.interesse - anterior) / anterior * 100).toFixed(1);
                }
                
                return `
                    <div class="dest-card">
                        <div class="dest-header">
                            <div class="dest-name">${info.emoji} ${info.nome}</div>
                            <div class="dest-rank">#${index + 1} PA</div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-label">Interesse</div>
                            <div class="metric-value">${dest.interesse}/100</div>
                        </div>
                        
                        ${variacao !== null ? `
                        <div class="metric-row">
                            <div class="metric-label">Varia√ß√£o</div>
                            <div class="metric-value ${variacao >= 0 ? 'positive' : 'negative'}">
                                ${variacao >= 0 ? '+' : ''}${variacao}%
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="metric-row">
                            <div class="metric-label">Share PA</div>
                            <div class="metric-value">${dest.share}%</div>
                        </div>
                        
                        <div class="origins-list">
                            ${dest.origem_1 ? `
                                <div class="origin-item">
                                    <span class="origin-name">ü•á ${dest.origem_1}</span>
                                    <span class="origin-pct">${dest.origem_1_pct}%</span>
                                </div>
                            ` : ''}
                            ${dest.origem_2 ? `
                                <div class="origin-item">
                                    <span class="origin-name">ü•à ${dest.origem_2}</span>
                                    <span class="origin-pct">${dest.origem_2_pct}%</span>
                                </div>
                            ` : ''}
                            ${dest.origem_3 ? `
                                <div class="origin-item">
                                    <span class="origin-name">ü•â ${dest.origem_3}</span>
                                    <span class="origin-pct">${dest.origem_3_pct}%</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ========== RENDERIZAR TIMELINE ==========
        function renderizarTimeline(dados) {
            // Pegar top 5 destinos
            const ultimaData = dados[0].data_coleta;
            const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);
            const top5 = dadosUltimos
                .sort((a, b) => b.interesse - a.interesse)
                .slice(0, 5)
                .map(d => d.destino_id);
            
            // Preparar datasets
            const datasetsData = {};
            top5.forEach(destId => {
                datasetsData[destId] = dados
                    .filter(d => d.destino_id === destId)
                    .reverse()
                    .slice(-18);
            });
            
            const labels = datasetsData[top5[0]].map(d => {
                const date = new Date(d.data_coleta);
                return `${date.getDate()}/${date.getMonth() + 1}`;
            });
            
            const cores = ['#00c6ff', '#39ff14', '#ff3860', '#ffea00', '#9d4edd'];
            
            const datasets = top5.map((destId, i) => {
                const info = DESTINOS_INFO[destId];
                return {
                    label: info.nome,
                    data: datasetsData[destId].map(d => d.interesse),
                    borderColor: cores[i],
                    backgroundColor: cores[i] + '20',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            // Destruir chart anterior
            if (chartInstance) chartInstance.destroy();
            
            // Criar novo chart
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { color: '#eaf3ff', font: { size: 12, weight: 600 } }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 18, 22, 0.95)',
                            titleColor: '#00c6ff',
                            bodyColor: '#eaf3ff',
                            borderColor: '#00c6ff',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }
        
        // ========== GERAR BOLETIM ==========
        function gerarBoletim(dados) {
            const ultimaData = dados[0].data_coleta;
            const dadosUltimos = dados.filter(d => d.data_coleta === ultimaData);
            
            // Top 3
            const top3 = dadosUltimos
                .sort((a, b) => b.interesse - a.interesse)
                .slice(0, 3)
                .map(d => {
                    const info = DESTINOS_INFO[d.destino_id];
                    return `${info.emoji} ${info.nome} (${d.interesse})`;
                });
            
            // Origens agregadas
            const origensMap = {};
            dadosUltimos.forEach(d => {
                if (d.origem_1) {
                    origensMap[d.origem_1] = (origensMap[d.origem_1] || 0) + d.origem_1_pct * d.interesse;
                }
                if (d.origem_2) {
                    origensMap[d.origem_2] = (origensMap[d.origem_2] || 0) + d.origem_2_pct * d.interesse;
                }
                if (d.origem_3) {
                    origensMap[d.origem_3] = (origensMap[d.origem_3] || 0) + d.origem_3_pct * d.interesse;
                }
            });
            
            const topOrigens = Object.entries(origensMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([cidade]) => cidade);
            
            const dataFormatada = new Date(ultimaData).toLocaleDateString('pt-BR');
            
            const html = `
                <div class="boletim-section">
                    <div class="boletim-section-title">üìÖ Data: ${dataFormatada}</div>
                </div>
                
                <div class="boletim-section">
                    <div class="boletim-section-title">üèÜ Top 3 Destinos PA</div>
                    <ul class="boletim-list">
                        ${top3.map(t => `<li>${t}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="boletim-section">
                    <div class="boletim-section-title">üåé Top 3 Origens Agregadas</div>
                    <ul class="boletim-list">
                        ${topOrigens.map(o => `<li>${o}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="boletim-section">
                    <div class="boletim-section-title">üí° Insights</div>
                    <p>Total de ${dadosUltimos.length} destinos monitorados. Dados coletados via Google Trends.</p>
                </div>
            `;
            
            document.getElementById('boletim-content').innerHTML = html;
        }
        
        // ========== COPIAR BOLETIM ==========
        function copiarBoletim() {
            const content = document.getElementById('boletim-content').innerText;
            navigator.clipboard.writeText(content).then(() => {
                alert('‚úÖ Boletim copiado para √°rea de transfer√™ncia!');
            });
        }
        
        // ========== CALEND√ÅRIO ==========
        function renderizarCalendario() {
            const ano = mesAtual.getFullYear();
            const mes = mesAtual.getMonth();
            
            const nomeMes = mesAtual.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('calendar-month').textContent = nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1);
            
            const primeiroDia = new Date(ano, mes, 1).getDay();
            const ultimoDia = new Date(ano, mes + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Labels dias da semana
            ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].forEach(dia => {
                const label = document.createElement('div');
                label.className = 'calendar-day-label';
                label.textContent = dia;
                grid.appendChild(label);
            });
            
            // Dias vazios antes do 1¬∫ dia
            for (let i = 0; i < primeiroDia; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day disabled';
                grid.appendChild(empty);
            }
            
            // Dias do m√™s
            for (let dia = 1; dia <= ultimoDia; dia++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = dia;
                
                const dataStr = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const temDados = dadosGlobais.some(d => d.data_coleta === dataStr);
                
                if (temDados) dayEl.classList.add('has-data');
                
                grid.appendChild(dayEl);
            }
        }
        
        function navegarMes(direcao) {
            mesAtual.setMonth(mesAtual.getMonth() + direcao);
            renderizarCalendario();
        }
        
        // ========== ESTADOS VAZIOS ==========
        function mostrarEstadoVazio() {
            document.getElementById('destinations-container').innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-state-icon">üå¥</div>
                    <p>Nenhum dado dispon√≠vel ainda.<br>Aguardando primeira coleta...</p>
                </div>
            `;
        }
        
        function mostrarErro(msg) {
            document.getElementById('destinations-container').innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>${msg}</p>
                </div>
            `;
        }
        
        // ========== INICIALIZA√á√ÉO ==========
        window.addEventListener('DOMContentLoaded', () => {
            atualizarDados();
        });
        
        // Filtro de per√≠odo
        document.getElementById('period-select').addEventListener('change', (e) => {
            const customDates = document.getElementById('custom-dates');
            customDates.style.display = e.target.value === 'custom' ? 'flex' : 'none';
        });
    </script>
</body>
</html>
